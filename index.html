<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schiffli Production Manager Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .status-pending { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
        .status-production { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); }
        .status-complete { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); }
        .status-approved { background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); }
        .status-quality-check { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
        .print-hidden { display: none !important; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }
        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .sync-online { background: #10b981; color: white; }
        .sync-offline { background: #f59e0b; color: white; }
        .sync-error { background: #ef4444; color: white; }
        .chart-container { height: 300px; }
        .efficiency-meter {
            background: conic-gradient(from 0deg, #ef4444 0deg 60deg, #f59e0b 60deg 120deg, #10b981 120deg 360deg);
            border-radius: 50%;
            position: relative;
        }
        .efficiency-inner {
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body class="bg-gray-50">


    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-md w-full mx-4">
            <div class="p-6 border-b">
                <h3 class="text-xl font-semibold text-center">Schiffli Production Manager</h3>
                <p class="text-sm text-gray-600 text-center mt-1">Please login to continue</p>
            </div>
            <div class="p-6">
                <form id="loginForm">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mobile Number</label>
                            <input type="tel" id="mobileNumber" required placeholder="Enter 10-digit mobile number" 
                                   pattern="[0-9]{10}" maxlength="10" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" id="password" required placeholder="Enter password" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="rememberMe" class="mr-2">
                            <label for="rememberMe" class="text-sm text-gray-600">Remember me</label>
                        </div>
                    </div>
                    <div class="mt-6">
                        <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">Login</button>
                    </div>
                </form>
                <div class="mt-4 text-center">
                    <button onclick="showDemoCredentials()" class="text-sm text-blue-600 hover:text-blue-700">View Demo Credentials</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Demo Credentials Modal -->
    <div id="demoCredentialsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-lg w-full mx-4">
            <div class="p-6 border-b">
                <h3 class="text-xl font-semibold">Demo Login Credentials</h3>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-medium text-blue-900">CEO/Admin</h4>
                        <p class="text-sm text-blue-700">Mobile: 9876543210</p>
                        <p class="text-sm text-blue-700">Password: admin123</p>
                        <p class="text-xs text-blue-600 mt-1">Full access to all features</p>
                    </div>
                    <div class="p-4 bg-green-50 rounded-lg">
                        <h4 class="font-medium text-green-900">Production Manager</h4>
                        <p class="text-sm text-green-700">Mobile: 9876543211</p>
                        <p class="text-sm text-green-700">Password: manager123</p>
                        <p class="text-xs text-green-600 mt-1">Production & workflow management</p>
                    </div>
                    <div class="p-4 bg-yellow-50 rounded-lg">
                        <h4 class="font-medium text-yellow-900">Operator</h4>
                        <p class="text-sm text-yellow-700">Mobile: 9876543212</p>
                        <p class="text-sm text-yellow-700">Password: operator123</p>
                        <p class="text-xs text-yellow-600 mt-1">View orders & update status</p>
                    </div>
                    <div class="p-4 bg-purple-50 rounded-lg">
                        <h4 class="font-medium text-purple-900">Quality Control</h4>
                        <p class="text-sm text-purple-700">Mobile: 9876543213</p>
                        <p class="text-sm text-purple-700">Password: qc123</p>
                        <p class="text-xs text-purple-600 mt-1">Quality checks & approvals</p>
                    </div>
                </div>
                <div class="mt-6 flex gap-4">
                    <button onclick="closeDemoCredentials()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Close</button>
                    <button onclick="fillDemoCredentials('admin')" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Use Admin Login</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-900">Schiffli Production Manager Pro</h1>
                <div class="flex gap-2 items-center flex-wrap">
                    <button onclick="showSection('dashboard')" id="dashboardBtn" class="nav-btn px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">Dashboard</button>
                    <button onclick="showSection('analytics')" id="analyticsBtn" class="nav-btn px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm">Analytics</button>
                    <button onclick="showSection('production')" id="productionBtn" class="nav-btn px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm">Production</button>
                    <button onclick="showSection('workflow')" id="workflowBtn" class="nav-btn px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm">Workflow</button>
                    <button onclick="showSection('orders')" id="ordersBtn" class="nav-btn px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm">Orders</button>
                    <button onclick="showSection('newOrder')" id="newOrderBtn" class="nav-btn px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm">New Order</button>

                    
                    <!-- User Profile -->
                    <div class="flex items-center gap-3 ml-4 pl-4 border-l border-gray-300">
                        <div class="text-right">
                            <p id="userDisplayName" class="text-sm font-medium text-gray-900">User</p>
                            <p id="userRole" class="text-xs text-gray-600">Role</p>
                        </div>
                        <div class="relative">
                            <button onclick="toggleUserMenu()" class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-medium hover:bg-blue-700">
                                <span id="userInitials">U</span>
                            </button>
                            <div id="userMenu" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border hidden z-50">
                                <div class="p-3 border-b">
                                    <p class="text-sm font-medium text-gray-900" id="menuUserName">User</p>
                                    <p class="text-xs text-gray-600" id="menuUserMobile">Mobile</p>
                                </div>
                                <div class="py-1">
                                    <button onclick="showUserProfile()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Profile Settings</button>
                                    <button onclick="showUserManagement()" id="userManagementBtn" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hidden">User Management</button>
                                    <button onclick="logout()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">Logout</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Section -->
    <div id="dashboardSection" class="max-w-7xl mx-auto px-6 py-8 hidden">
        <h2 class="text-3xl font-bold text-gray-900 mb-8">CEO Dashboard</h2>
        
        <!-- Stats Cards -->
        <div class="grid md:grid-cols-4 gap-6 mb-8">
            <div onclick="filterDashboardOrders('all')" class="bg-white rounded-lg p-6 shadow-sm border cursor-pointer hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Total Orders</p>
                        <p id="totalOrders" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <span class="text-blue-600 text-xl">üìã</span>
                    </div>
                </div>
            </div>
            
            <div onclick="filterDashboardOrders('production')" class="bg-white rounded-lg p-6 shadow-sm border cursor-pointer hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">In Production</p>
                        <p id="inProductionCount" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <span class="text-blue-600 text-xl">‚öôÔ∏è</span>
                    </div>
                </div>
            </div>
            
            <div onclick="filterDashboardOrders('complete')" class="bg-white rounded-lg p-6 shadow-sm border cursor-pointer hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Completed</p>
                        <p id="completedCount" class="text-2xl font-bold text-green-600">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <span class="text-green-600 text-xl">‚úÖ</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm border">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Efficiency</p>
                        <p id="overallEfficiency" class="text-2xl font-bold text-purple-600">0%</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                        <span class="text-purple-600 text-xl">üìä</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg p-6 shadow-sm border">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h3>
                <div class="space-y-3">
                    <button onclick="showSection('newOrder')" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">Create New Order</button>
                    <button onclick="generateProductionReport()" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">Generate Report</button>
                    <button onclick="showSection('production')" class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">Machine Status</button>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm border">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Today's Metrics</h3>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600 text-sm">Orders Created:</span>
                        <span id="todayOrders" class="font-medium">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 text-sm">Meters Produced:</span>
                        <span id="todayMeters" class="font-medium">0m</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 text-sm">Active Machines:</span>
                        <span id="activeMachines" class="font-medium">0</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm border">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Alerts & Notifications</h3>
                <div id="alertsList" class="space-y-2">
                    <p class="text-gray-500 text-sm">No alerts</p>
                </div>
            </div>
        </div>

        <!-- Recent Orders -->
        <div class="bg-white rounded-lg shadow-sm border">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">Recent Orders</h3>
                <div class="text-sm text-gray-600">
                    <span id="orderFilterStatus">Showing all orders</span>
                </div>
            </div>
            <div id="recentOrdersList" class="p-6">
                <p class="text-gray-500 text-center py-8">No orders yet</p>
            </div>
        </div>
    </div>

    <!-- Analytics Section -->
    <div id="analyticsSection" class="max-w-7xl mx-auto px-6 py-8 hidden">
        <h2 class="text-3xl font-bold text-gray-900 mb-8">Advanced Analytics & Reports</h2>
        
        <div class="grid md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg p-6 shadow-sm border">
                <h3 class="text-sm font-medium text-gray-600 mb-2">Production Efficiency</h3>
                <p class="text-2xl font-bold text-gray-900">85%</p>
                <p class="text-xs text-green-600">‚Üó +5% vs last period</p>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm border">
                <h3 class="text-sm font-medium text-gray-600 mb-2">Average Order Time</h3>
                <p class="text-2xl font-bold text-gray-900">2.3 days</p>
                <p class="text-xs text-green-600">‚Üó 15% faster</p>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm border">
                <h3 class="text-sm font-medium text-gray-600 mb-2">Machine Utilization</h3>
                <p class="text-2xl font-bold text-gray-900">78%</p>
                <p class="text-xs text-yellow-600">‚Üí Same as last period</p>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm border">
                <h3 class="text-sm font-medium text-gray-600 mb-2">Quality Score</h3>
                <p class="text-2xl font-bold text-gray-900">94%</p>
                <p class="text-xs text-green-600">‚Üó +2% improvement</p>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Analytics Dashboard</h3>
            <p class="text-gray-600">Comprehensive analytics and reporting features are available here.</p>
        </div>
    </div>

    <!-- Production Section -->
    <div id="productionSection" class="max-w-7xl mx-auto px-6 py-8 hidden">
        <h2 class="text-3xl font-bold text-gray-900 mb-8">Production Management</h2>
        
        <div class="grid md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-sm border">
                <div class="p-6 border-b">
                    <h3 class="text-lg font-semibold text-gray-900">Machine Status</h3>
                </div>
                <div class="p-6">
                    <div id="machineStatusList" class="space-y-3">
                        <div class="flex justify-between items-center p-3 border rounded">
                            <div>
                                <h4 class="font-medium text-sm">Machine-01</h4>
                                <p class="text-xs text-gray-600">Efficiency: 85%</p>
                            </div>
                            <span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800">Active</span>
                        </div>
                        <div class="flex justify-between items-center p-3 border rounded">
                            <div>
                                <h4 class="font-medium text-sm">Machine-02</h4>
                                <p class="text-xs text-gray-600">Efficiency: 78%</p>
                            </div>
                            <span class="px-2 py-1 text-xs rounded bg-gray-100 text-gray-800">Idle</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm border">
                <div class="p-6 border-b">
                    <h3 class="text-lg font-semibold text-gray-900">Yarn Inventory</h3>
                </div>
                <div class="p-6">
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-3 border rounded">
                            <div>
                                <h4 class="font-medium text-sm">Cotton-White</h4>
                                <p class="text-xs text-gray-600">250 kg</p>
                            </div>
                            <span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800">OK</span>
                        </div>
                        <div class="flex justify-between items-center p-3 border rounded">
                            <div>
                                <h4 class="font-medium text-sm">Polyester-Blue</h4>
                                <p class="text-xs text-gray-600">45 kg</p>
                            </div>
                            <span class="px-2 py-1 text-xs rounded bg-red-100 text-red-800">Low</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm border">
                <div class="p-6 border-b">
                    <h3 class="text-lg font-semibold text-gray-900">Production Estimates</h3>
                </div>
                <div class="p-6">
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Pending Orders:</span>
                            <span class="font-medium">12</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Total Meters:</span>
                            <span class="font-medium">1,250m</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Est. Completion:</span>
                            <span class="font-medium">5 days</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Workflow Section -->
    <div id="workflowSection" class="max-w-7xl mx-auto px-6 py-8 hidden">
        <h2 class="text-3xl font-bold text-gray-900 mb-8">Workflow Management</h2>
        
        <div class="grid md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg p-6 shadow-sm border text-center">
                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-yellow-600 text-2xl">‚è≥</span>
                </div>
                <h3 class="font-semibold text-gray-900">Pending Approval</h3>
                <p class="text-2xl font-bold text-yellow-600">3</p>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm border text-center">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-blue-600 text-2xl">‚úÖ</span>
                </div>
                <h3 class="font-semibold text-gray-900">Approved</h3>
                <p class="text-2xl font-bold text-blue-600">8</p>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm border text-center">
                <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-orange-600 text-2xl">üîç</span>
                </div>
                <h3 class="font-semibold text-gray-900">Quality Check</h3>
                <p class="text-2xl font-bold text-orange-600">2</p>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm border text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-green-600 text-2xl">üì¶</span>
                </div>
                <h3 class="font-semibold text-gray-900">Ready for Delivery</h3>
                <p class="text-2xl font-bold text-green-600">5</p>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Workflow Status</h3>
            <p class="text-gray-600">Order workflow management and approval system.</p>
        </div>
    </div>

    <!-- Orders Section -->
    <div id="ordersSection" class="max-w-7xl mx-auto px-6 py-8 hidden">
        <h2 class="text-3xl font-bold text-gray-900 mb-8">Production Orders</h2>
        
        <!-- Filter Buttons -->
        <div class="flex gap-2 mb-6 flex-wrap">
            <button onclick="filterOrders('all')" id="filterAll" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">All Orders</button>
            <button onclick="filterOrders('pending-approval')" id="filterPending" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm">Pending Approval</button>
            <button onclick="filterOrders('production')" id="filterProduction" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm">In Production</button>
            <button onclick="filterOrders('quality-check')" id="filterQuality" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm">Quality Check</button>
            <button onclick="filterOrders('complete')" id="filterComplete" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm">Completed</button>
        </div>
        
        <div class="bg-white rounded-lg shadow-sm border">
            <div class="p-6 border-b">
                <h3 class="text-lg font-semibold text-gray-900">Order Management</h3>
            </div>
            <div id="ordersList" class="p-6">
                <p class="text-gray-500 text-center py-8">No orders found</p>
            </div>
        </div>
    </div>

    <!-- New Order Section -->
    <div id="newOrderSection" class="max-w-4xl mx-auto px-6 py-8 hidden">
        <h2 class="text-3xl font-bold text-gray-900 mb-8">Create New Order</h2>
        
        <form id="orderForm" class="bg-white rounded-lg shadow-sm border p-8">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Order Details -->
                <div class="space-y-6">
                    <h3 class="text-lg font-semibold text-gray-900 border-b pb-2">Order Details</h3>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Order ID</label>
                        <input type="text" id="orderId" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" readonly>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Customer Name *</label>
                        <input type="text" id="customerName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Design Number *</label>
                        <input type="text" id="designNumber" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Meters to Produce *</label>
                        <input type="number" id="metersCount" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <!-- Fabric Details -->
                <div class="space-y-6">
                    <h3 class="text-lg font-semibold text-gray-900 border-b pb-2">Fabric & Production</h3>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fabric Type *</label>
                        <select id="fabricType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select Fabric</option>
                            <option value="Cotton">Cotton</option>
                            <option value="Polyester">Polyester</option>
                            <option value="Silk">Silk</option>
                            <option value="Linen">Linen</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fabric Color *</label>
                        <input type="text" id="fabricColor" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Embroidery Placement *</label>
                        <select id="embroideryPlacement" required onchange="toggleCustomPlacement()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select Placement</option>
                            <option value="Front">Front</option>
                            <option value="Back">Back</option>
                            <option value="Sleeve">Sleeve</option>
                            <option value="Chest">Chest</option>
                            <option value="Custom">Custom</option>
                        </select>
                    </div>
                    
                    <div id="customPlacementDiv" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Custom Placement Details</label>
                        <input type="text" id="customPlacement" placeholder="Specify custom placement" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Repeat Size *</label>
                        <input type="text" id="repeatSize" required placeholder="e.g., 10cm x 15cm" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Yarn Code *</label>
                        <input type="text" id="yarnCode" required placeholder="e.g., YC-001, YC-002" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Design Image</label>
                        <input type="file" id="designImage" accept="image/*" onchange="handleImageUpload(this)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Upload design image (JPG, PNG, GIF)</p>
                        <div id="imagePreview" class="mt-2 hidden">
                            <img id="previewImg" src="" alt="Design Preview" class="w-32 h-32 object-cover border rounded">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Assigned Machine *</label>
                        <select id="assignedMachine" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select Machine</option>
                            <option value="Machine-01">Machine-01</option>
                            <option value="Machine-02">Machine-02</option>
                            <option value="Machine-03">Machine-03</option>
                            <option value="Machine-04">Machine-04</option>
                            <option value="Machine-05">Machine-05</option>
                            <option value="Machine-06">Machine-06</option>
                            <option value="Machine-07">Machine-07</option>
                            <option value="Machine-08">Machine-08</option>
                            <option value="Machine-09">Machine-09</option>
                            <option value="Machine-10">Machine-10</option>
                            <option value="Machine-11">Machine-11</option>
                            <option value="Machine-12">Machine-12</option>
                            <option value="Machine-13">Machine-13</option>
                            <option value="Machine-14">Machine-14</option>
                            <option value="Machine-15">Machine-15</option>
                            <option value="Machine-16">Machine-16</option>
                            <option value="Machine-17">Machine-17</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4 mt-8">
                <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">Create Order</button>
                <button type="button" onclick="resetOrderForm()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">Reset</button>
            </div>
        </form>
    </div>

    <!-- Job Card Modal -->
    <div id="jobCardModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-semibold">Job Card</h3>
                <div class="flex gap-2">
                    <button onclick="printJobCard()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">Print</button>
                    <button onclick="saveJobCard()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">Save PDF</button>
                    <button onclick="closeJobCard()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm">Close</button>
                </div>
            </div>
            <div id="jobCardContent" class="p-8" style="width: 210mm; min-height: 297mm; margin: 0 auto; background: white;">
                <!-- Job card content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let orders = [];
        let dailyCounter = {};
        let machines = [];
        let yarnInventory = [];
        let maintenanceSchedule = [];
        let productionBatches = [];
        let users = [];
        let currentUser = null;
        
        // User roles and permissions
        const userRoles = {
            admin: {
                name: 'Admin',
                permissions: ['all'],
                sections: ['dashboard', 'analytics', 'production', 'workflow', 'orders', 'newOrder', 'userManagement']
            },
            manager: {
                name: 'Production Manager',
                permissions: ['view_all', 'manage_production', 'manage_workflow', 'create_orders', 'approve_orders'],
                sections: ['dashboard', 'analytics', 'production', 'workflow', 'orders', 'newOrder']
            },
            operator: {
                name: 'Operator',
                permissions: ['view_orders', 'update_status'],
                sections: ['dashboard', 'orders']
            },
            qc: {
                name: 'Quality Control',
                permissions: ['view_orders', 'quality_check', 'approve_quality'],
                sections: ['dashboard', 'workflow', 'orders']
            }
        };
        
        // Initialize demo users
        function initializeUsers() {
            if (users.length === 0) {
                users = [
                    {
                        id: 'user_1',
                        name: 'Admin User',
                        mobile: '9876543210',
                        password: 'admin123',
                        role: 'admin',
                        department: 'Management',
                        createdDate: new Date().toLocaleDateString(),
                        lastLogin: null
                    },
                    {
                        id: 'user_2',
                        name: 'Production Manager',
                        mobile: '9876543211',
                        password: 'manager123',
                        role: 'manager',
                        department: 'Production',
                        createdDate: new Date().toLocaleDateString(),
                        lastLogin: null
                    },
                    {
                        id: 'user_3',
                        name: 'Machine Operator',
                        mobile: '9876543212',
                        password: 'operator123',
                        role: 'operator',
                        department: 'Production',
                        createdDate: new Date().toLocaleDateString(),
                        lastLogin: null
                    },
                    {
                        id: 'user_4',
                        name: 'Quality Controller',
                        mobile: '9876543213',
                        password: 'qc123',
                        role: 'qc',
                        department: 'Quality',
                        createdDate: new Date().toLocaleDateString(),
                        lastLogin: null
                    }
                ];
                saveData();
            }
        }
        
        // Initialize machines
        function initializeMachines() {
            if (machines.length === 0) {
                for (let i = 1; i <= 17; i++) {
                    machines.push({
                        id: `Machine-${String(i).padStart(2, '0')}`,
                        status: Math.random() > 0.3 ? 'active' : 'idle',
                        efficiency: Math.floor(Math.random() * 30) + 70,
                        lastMaintenance: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toLocaleDateString(),
                        hoursUsed: Math.floor(Math.random() * 2000) + 500,
                        currentOrder: null
                    });
                }
                saveData();
            }
        }
        
        // Data management
        function loadData() {
            try {
                orders = JSON.parse(localStorage.getItem('schiffliOrders')) || [];
                dailyCounter = JSON.parse(localStorage.getItem('dailyCounter')) || {};
                machines = JSON.parse(localStorage.getItem('machines')) || [];
                yarnInventory = JSON.parse(localStorage.getItem('yarnInventory')) || [];
                maintenanceSchedule = JSON.parse(localStorage.getItem('maintenanceSchedule')) || [];
                productionBatches = JSON.parse(localStorage.getItem('productionBatches')) || [];
                users = JSON.parse(localStorage.getItem('schiffliUsers')) || [];
                currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function saveData() {
            try {
                localStorage.setItem('schiffliOrders', JSON.stringify(orders));
                localStorage.setItem('dailyCounter', JSON.stringify(dailyCounter));
                localStorage.setItem('machines', JSON.stringify(machines));
                localStorage.setItem('yarnInventory', JSON.stringify(yarnInventory));
                localStorage.setItem('maintenanceSchedule', JSON.stringify(maintenanceSchedule));
                localStorage.setItem('productionBatches', JSON.stringify(productionBatches));
                localStorage.setItem('schiffliUsers', JSON.stringify(users));
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }
        
        // Authentication functions
        function authenticateUser(mobile, password) {
            console.log('Authenticating user:', mobile);
            console.log('Available users:', users.length);
            
            const user = users.find(u => u.mobile === mobile && u.password === password);
            console.log('Found user:', user);
            
            if (user) {
                currentUser = { ...user };
                currentUser.lastLogin = new Date().toLocaleString();
                
                // Update user's last login
                const userIndex = users.findIndex(u => u.id === user.id);
                if (userIndex !== -1) {
                    users[userIndex].lastLogin = currentUser.lastLogin;
                }
                
                saveData();
                return true;
            }
            return false;
        }
        
        function checkPermission(permission) {
            if (!currentUser) return false;
            const role = userRoles[currentUser.role];
            return role && (role.permissions.includes('all') || role.permissions.includes(permission));
        }
        
        function canAccessSection(section) {
            if (!currentUser) return false;
            const role = userRoles[currentUser.role];
            return role && role.sections.includes(section);
        }
        
        function updateUserInterface() {
            if (!currentUser) return;
            
            console.log('Updating UI for user:', currentUser.name);
            
            // Update user display
            document.getElementById('userDisplayName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = userRoles[currentUser.role].name;
            document.getElementById('userInitials').textContent = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
            document.getElementById('menuUserName').textContent = currentUser.name;
            document.getElementById('menuUserMobile').textContent = currentUser.mobile;
            
            // Show/hide navigation buttons based on permissions
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => {
                const section = btn.id.replace('Btn', '');
                if (!canAccessSection(section)) {
                    btn.style.display = 'none';
                } else {
                    btn.style.display = 'inline-block';
                }
            });
            
            // Show user management button for admins
            if (currentUser.role === 'admin') {
                document.getElementById('userManagementBtn').classList.remove('hidden');
            }
        }
        
        // Global functions
        window.showDemoCredentials = function() {
            document.getElementById('demoCredentialsModal').classList.remove('hidden');
            document.getElementById('demoCredentialsModal').classList.add('flex');
        }
        
        window.closeDemoCredentials = function() {
            document.getElementById('demoCredentialsModal').classList.add('hidden');
            document.getElementById('demoCredentialsModal').classList.remove('flex');
        }
        
        window.fillDemoCredentials = function(type) {
            const credentials = {
                admin: { mobile: '9876543210', password: 'admin123' },
                manager: { mobile: '9876543211', password: 'manager123' },
                operator: { mobile: '9876543212', password: 'operator123' },
                qc: { mobile: '9876543213', password: 'qc123' }
            };
            
            if (credentials[type]) {
                document.getElementById('mobileNumber').value = credentials[type].mobile;
                document.getElementById('password').value = credentials[type].password;
            }
            
            closeDemoCredentials();
        }
        
        window.toggleUserMenu = function() {
            const menu = document.getElementById('userMenu');
            menu.classList.toggle('hidden');
        }
        
        window.logout = function() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            location.reload(); // Simple reload to reset everything
        }
        
        window.showSection = function(section) {
            console.log('Showing section:', section);
            
            // Check permissions
            if (!canAccessSection(section)) {
                alert('Access denied. You do not have permission to view this section.');
                return;
            }
            
            // Hide all sections
            const sections = ['dashboard', 'analytics', 'production', 'workflow', 'orders', 'newOrder'];
            sections.forEach(s => {
                const element = document.getElementById(s + 'Section');
                if (element) {
                    element.classList.add('hidden');
                }
            });
            
            // Reset all navigation button styles
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => {
                btn.className = 'nav-btn px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm';
            });
            
            // Show selected section and highlight button
            const targetSection = document.getElementById(section + 'Section');
            const targetButton = document.getElementById(section + 'Btn');
            
            if (targetSection) {
                targetSection.classList.remove('hidden');
                console.log('Section shown:', section);
            }
            
            if (targetButton) {
                targetButton.className = 'nav-btn px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm';
            }
            
            // Update section-specific data and generate order ID for new orders
            if (section === 'dashboard') {
                updateDashboard();
                updateRecentOrders();
            } else if (section === 'newOrder') {
                generateOrderId();
                setupOrderForm();
            } else if (section === 'orders') {
                filterOrders('all');
            }
        }
        
        window.toggleGoogleDriveSync = function() {
            alert(`üöÄ Your Schiffli Production Manager Pro is ready to deploy!

üìã CURRENT STATUS:
‚úÖ Fully functional with local storage
‚úÖ Advanced analytics and reporting
‚úÖ Production management features
‚úÖ Workflow automation
‚úÖ Business intelligence

‚òÅÔ∏è GOOGLE DRIVE SYNC (Optional):
Want multi-device sync? I can help you set up Google Drive integration later.

üì§ DEPLOYMENT READY:
Your enhanced app is optimized for GitHub Pages deployment right now!

Click OK to continue using local storage.`);
        }
        
        // Dashboard functions
        function updateDashboard() {
            const totalOrders = orders.length;
            const inProduction = orders.filter(o => o.status === 'production').length;
            const completed = orders.filter(o => o.status === 'complete').length;
            const efficiency = calculateOverallEfficiency();
            
            document.getElementById('totalOrders').textContent = totalOrders;
            document.getElementById('inProductionCount').textContent = inProduction;
            document.getElementById('completedCount').textContent = completed;
            document.getElementById('overallEfficiency').textContent = efficiency + '%';
            
            // Today's metrics
            const today = new Date().toLocaleDateString();
            const todayOrders = orders.filter(o => o.createdDate === today).length;
            const todayMeters = orders.filter(o => o.createdDate === today)
                .reduce((sum, o) => sum + o.metersCount, 0);
            const activeMachineCount = machines.filter(m => m.status === 'active').length;
            
            document.getElementById('todayOrders').textContent = todayOrders;
            document.getElementById('todayMeters').textContent = todayMeters + 'm';
            document.getElementById('activeMachines').textContent = activeMachineCount;
        }
        
        function calculateOverallEfficiency() {
            if (machines.length === 0) return 85; // Default value
            const totalEfficiency = machines.reduce((sum, m) => sum + m.efficiency, 0);
            return Math.round(totalEfficiency / machines.length);
        }
        
        window.generateProductionReport = function() {
            try {
                // Calculate comprehensive report data
                const totalOrders = orders.length;
                const inProduction = orders.filter(o => o.status === 'production').length;
                const completed = orders.filter(o => o.status === 'complete').length;
                const pending = orders.filter(o => o.status === 'pending-approval').length;
                const qualityCheck = orders.filter(o => o.status === 'quality-check').length;
                const efficiency = calculateOverallEfficiency();
                const activeMachines = machines.filter(m => m.status === 'active').length;
                const totalMeters = orders.reduce((sum, o) => sum + o.metersCount, 0);
                const completedMeters = orders.filter(o => o.status === 'complete').reduce((sum, o) => sum + o.metersCount, 0);
                
                // Today's data
                const today = new Date().toLocaleDateString();
                const todayOrders = orders.filter(o => o.createdDate === today).length;
                const todayMeters = orders.filter(o => o.createdDate === today).reduce((sum, o) => sum + o.metersCount, 0);
                
                // Check if jsPDF is available
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('jsPDF library not available');
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                // Add header
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                doc.text('PRODUCTION REPORT', 105, 25, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`Generated: ${new Date().toLocaleString()}`, 105, 35, { align: 'center' });
                doc.text(`Report Period: All Time`, 105, 42, { align: 'center' });
                
                let yPos = 60;
                
                // Executive Summary
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('EXECUTIVE SUMMARY', 20, yPos);
                yPos += 15;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                doc.text(`Total Orders Processed: ${totalOrders}`, 25, yPos);
                yPos += 7;
                doc.text(`Total Meters Produced: ${totalMeters}m`, 25, yPos);
                yPos += 7;
                doc.text(`Completed Meters: ${completedMeters}m`, 25, yPos);
                yPos += 7;
                doc.text(`Overall Production Efficiency: ${efficiency}%`, 25, yPos);
                yPos += 7;
                doc.text(`Active Machines: ${activeMachines} out of 17 (${Math.round(activeMachines/17*100)}%)`, 25, yPos);
                yPos += 20;
                
                // Order Status Breakdown
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('ORDER STATUS BREAKDOWN', 20, yPos);
                yPos += 15;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                doc.text(`üìã Total Orders: ${totalOrders}`, 25, yPos);
                yPos += 7;
                doc.text(`‚è≥ Pending Approval: ${pending} (${totalOrders > 0 ? Math.round(pending/totalOrders*100) : 0}%)`, 25, yPos);
                yPos += 7;
                doc.text(`‚öôÔ∏è In Production: ${inProduction} (${totalOrders > 0 ? Math.round(inProduction/totalOrders*100) : 0}%)`, 25, yPos);
                yPos += 7;
                doc.text(`üîç Quality Check: ${qualityCheck} (${totalOrders > 0 ? Math.round(qualityCheck/totalOrders*100) : 0}%)`, 25, yPos);
                yPos += 7;
                doc.text(`‚úÖ Completed: ${completed} (${totalOrders > 0 ? Math.round(completed/totalOrders*100) : 0}%)`, 25, yPos);
                yPos += 20;
                
                // Today's Performance
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('TODAY\'S PERFORMANCE', 20, yPos);
                yPos += 15;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                doc.text(`Orders Created Today: ${todayOrders}`, 25, yPos);
                yPos += 7;
                doc.text(`Meters Ordered Today: ${todayMeters}m`, 25, yPos);
                yPos += 7;
                doc.text(`Date: ${today}`, 25, yPos);
                yPos += 20;
                
                // Machine Status
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('MACHINE STATUS OVERVIEW', 20, yPos);
                yPos += 15;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                const idleMachines = machines.filter(m => m.status === 'idle').length;
                doc.text(`Active Machines: ${activeMachines}`, 25, yPos);
                yPos += 7;
                doc.text(`Idle Machines: ${idleMachines}`, 25, yPos);
                yPos += 7;
                doc.text(`Total Machines: 17`, 25, yPos);
                yPos += 7;
                doc.text(`Utilization Rate: ${Math.round(activeMachines/17*100)}%`, 25, yPos);
                yPos += 20;
                
                // Recent Orders (if space allows)
                if (yPos < 220 && orders.length > 0) {
                    doc.setFontSize(16);
                    doc.setFont(undefined, 'bold');
                    doc.text('RECENT ORDERS', 20, yPos);
                    yPos += 15;
                    
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    const recentOrders = orders.slice(-8).reverse(); // Show last 8 orders
                    recentOrders.forEach(order => {
                        if (yPos > 270) return; // Stop if we run out of space
                        doc.text(`${order.id} | ${order.customerName} | ${order.designNumber} | ${order.status.toUpperCase()}`, 25, yPos);
                        yPos += 5;
                    });
                }
                
                // Footer
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.text('Schiffli Production Manager Pro - Confidential Report', 105, 285, { align: 'center' });
                doc.text(`Page 1 of 1`, 105, 290, { align: 'center' });
                
                // Save the PDF
                const fileName = `Production_Report_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                alert('‚úÖ Production Report Generated Successfully!\n\nüìÑ PDF has been downloaded to your device.\n\nüìä Report includes:\n‚Ä¢ Executive Summary\n‚Ä¢ Order Status Breakdown\n‚Ä¢ Machine Utilization\n‚Ä¢ Today\'s Performance\n‚Ä¢ Recent Orders');
                
            } catch (error) {
                console.error('Report generation error:', error);
                
                // Enhanced fallback with downloadable text report
                const totalOrders = orders.length;
                const inProduction = orders.filter(o => o.status === 'production').length;
                const completed = orders.filter(o => o.status === 'complete').length;
                const pending = orders.filter(o => o.status === 'pending-approval').length;
                const qualityCheck = orders.filter(o => o.status === 'quality-check').length;
                const efficiency = calculateOverallEfficiency();
                const activeMachines = machines.filter(m => m.status === 'active').length;
                const totalMeters = orders.reduce((sum, o) => sum + o.metersCount, 0);
                
                const reportText = `
SCHIFFLI PRODUCTION MANAGER - PRODUCTION REPORT
Generated: ${new Date().toLocaleString()}

EXECUTIVE SUMMARY:
Total Orders: ${totalOrders}
Total Meters: ${totalMeters}m
Production Efficiency: ${efficiency}%
Active Machines: ${activeMachines}/17

ORDER STATUS BREAKDOWN:
Pending Approval: ${pending}
In Production: ${inProduction}
Quality Check: ${qualityCheck}
Completed: ${completed}

MACHINE UTILIZATION:
Active: ${activeMachines}
Idle: ${17 - activeMachines}
Utilization Rate: ${Math.round(activeMachines/17*100)}%

RECENT ORDERS:
${orders.slice(-10).reverse().map(o => `${o.id} - ${o.customerName} - ${o.status.toUpperCase()}`).join('\n')}

Report generated by Schiffli Production Manager Pro
                `;
                
                // Create downloadable text file
                const blob = new Blob([reportText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Production_Report_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('üìä PRODUCTION REPORT GENERATED!\n\n' +
                      `üìã Total Orders: ${totalOrders}\n` +
                      `‚öôÔ∏è In Production: ${inProduction}\n` +
                      `‚úÖ Completed: ${completed}\n` +
                      `‚è≥ Pending: ${pending}\n` +
                      `üìà Efficiency: ${efficiency}%\n` +
                      `üè≠ Active Machines: ${activeMachines}/17\n\n` +
                      'üìÑ Report downloaded as text file!\n' +
                      'PDF generation not available in this environment.');
            }
        }
        
        // Order management functions
        function generateOrderId() {
            const today = new Date();
            const year = today.getFullYear().toString().slice(-2);
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateKey = year + month + day;
            
            if (!dailyCounter[dateKey]) {
                dailyCounter[dateKey] = 1;
            }
            
            const orderNumber = String(dailyCounter[dateKey]).padStart(2, '0');
            const orderId = dateKey + orderNumber;
            
            const orderIdField = document.getElementById('orderId');
            if (orderIdField) {
                orderIdField.value = orderId;
            }
        }
        
        function setupOrderForm() {
            const orderForm = document.getElementById('orderForm');
            if (orderForm) {
                // Remove existing event listeners
                const newForm = orderForm.cloneNode(true);
                orderForm.parentNode.replaceChild(newForm, orderForm);
                
                newForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    createOrder();
                });
            }
        }
        
        function createOrder() {
            const orderId = document.getElementById('orderId').value;
            
            // Check if order ID already exists
            if (orders.find(o => o.id === orderId)) {
                alert('Order ID already exists! Please refresh to get a new ID.');
                return;
            }
            
            // Get assigned machine (now required)
            const assignedMachine = document.getElementById('assignedMachine').value;
            if (!assignedMachine) {
                alert('Please select an assigned machine');
                return;
            }
            
            // Get design image if uploaded
            const designImageInput = document.getElementById('designImage');
            let designImage = '';
            if (designImageInput.files[0]) {
                const previewImg = document.getElementById('previewImg');
                designImage = previewImg.src;
            }
            
            // Handle custom placement
            let embroideryPlacement = document.getElementById('embroideryPlacement').value;
            if (embroideryPlacement === 'Custom') {
                const customPlacement = document.getElementById('customPlacement').value;
                if (!customPlacement) {
                    alert('Please specify custom placement details');
                    return;
                }
                embroideryPlacement = customPlacement;
            }
            
            // Calculate estimated completion date
            const estimatedDays = 3; // Default 3 days
            const completionDate = new Date();
            completionDate.setDate(completionDate.getDate() + estimatedDays);
            
            const order = {
                id: orderId,
                customerName: document.getElementById('customerName').value,
                designNumber: document.getElementById('designNumber').value,
                fabricType: document.getElementById('fabricType').value,
                fabricColor: document.getElementById('fabricColor').value,
                metersCount: parseInt(document.getElementById('metersCount').value),
                embroideryPlacement: embroideryPlacement,
                repeatSize: document.getElementById('repeatSize').value,
                yarnCode: document.getElementById('yarnCode').value,
                assignedMachine: assignedMachine,
                designImage: designImage,
                status: 'pending-approval',
                workflowStage: 'pending-approval',
                priority: 'normal',
                estimatedCompletion: completionDate.toLocaleDateString(),
                createdDate: new Date().toLocaleDateString(),
                createdTime: new Date().toLocaleTimeString(),
                productionTime: 0,
                qualityChecks: [],
                approvedBy: null,
                approvedDate: null
            };
            
            orders.push(order);
            
            // Update daily counter
            const today = new Date();
            const year = today.getFullYear().toString().slice(-2);
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateKey = year + month + day;
            dailyCounter[dateKey]++;
            
            saveData();
            
            alert('Order created successfully and sent for approval!');
            
            resetOrderForm();
            generateOrderId();
            updateDashboard();
            updateRecentOrders();
        }
        
        window.resetOrderForm = function() {
            const orderForm = document.getElementById('orderForm');
            if (orderForm) {
                orderForm.reset();
                // Hide image preview
                document.getElementById('imagePreview').classList.add('hidden');
                document.getElementById('customPlacementDiv').classList.add('hidden');
                generateOrderId();
            }
        }
        
        // Setup login form
        function setupLoginForm() {
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('Login form submitted');
                    
                    const mobile = document.getElementById('mobileNumber').value.trim();
                    const password = document.getElementById('password').value.trim();
                    
                    console.log('Attempting login with mobile:', mobile);
                    
                    if (!mobile || !password) {
                        alert('Please enter both mobile number and password');
                        return;
                    }
                    
                    if (authenticateUser(mobile, password)) {
                        console.log('Authentication successful');
                        
                        // Hide login modal
                        document.getElementById('loginModal').classList.add('hidden');
                        document.getElementById('loginModal').classList.remove('flex');
                        
                        // Update UI and show dashboard
                        updateUserInterface();
                        updateDashboard();
                        showSection('dashboard');
                        
                        alert(`Welcome, ${currentUser.name}!`);
                    } else {
                        console.log('Authentication failed');
                        alert('Invalid mobile number or password!\n\nTry demo credentials:\nAdmin: 9876543210 / admin123');
                    }
                });
            }
        }
        
        // Dashboard filtering functions
        window.filterDashboardOrders = function(filter) {
            let filteredOrders = orders;
            let statusText = 'Showing all orders';
            
            if (filter === 'production') {
                filteredOrders = orders.filter(o => o.status === 'production');
                statusText = 'Showing orders in production';
            } else if (filter === 'complete') {
                filteredOrders = orders.filter(o => o.status === 'complete');
                statusText = 'Showing completed orders';
            } else if (filter === 'pending') {
                filteredOrders = orders.filter(o => o.status === 'pending-approval');
                statusText = 'Showing pending orders';
            }
            
            document.getElementById('orderFilterStatus').textContent = statusText;
            displayRecentOrders(filteredOrders);
        }
        
        function updateRecentOrders() {
            displayRecentOrders(orders);
        }
        
        function displayRecentOrders(orderList) {
            const recentOrdersList = document.getElementById('recentOrdersList');
            
            if (orderList.length === 0) {
                recentOrdersList.innerHTML = '<p class="text-gray-500 text-center py-8">No orders found</p>';
                return;
            }
            
            const recentOrders = orderList.slice(-10).reverse(); // Show last 10 orders
            
            let html = '<div class="space-y-4">';
            recentOrders.forEach(order => {
                const statusClass = getStatusClass(order.status);
                html += `
                    <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-semibold text-gray-900">${order.id}</h4>
                                <p class="text-sm text-gray-600">${order.customerName}</p>
                            </div>
                            <div class="text-right">
                                <span class="px-2 py-1 text-xs rounded ${statusClass}">${order.status.replace('-', ' ').toUpperCase()}</span>
                                <p class="text-xs text-gray-500 mt-1">${order.createdDate}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-600">Design:</span> ${order.designNumber}
                            </div>
                            <div>
                                <span class="text-gray-600">Meters:</span> ${order.metersCount}m
                            </div>
                            <div>
                                <span class="text-gray-600">Fabric:</span> ${order.fabricType}
                            </div>
                            <div>
                                <span class="text-gray-600">Machine:</span> ${order.assignedMachine}
                            </div>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button onclick="viewJobCard('${order.id}')" class="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">View Job Card</button>
                            <button onclick="updateOrderStatus('${order.id}')" class="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">Update Status</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            recentOrdersList.innerHTML = html;
        }
        
        // Orders section functions
        window.filterOrders = function(status) {
            // Update filter button styles
            document.querySelectorAll('[id^="filter"]').forEach(btn => {
                btn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm';
            });
            
            const activeBtn = document.getElementById('filter' + status.charAt(0).toUpperCase() + status.slice(1).replace('-', ''));
            if (activeBtn) {
                activeBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm';
            }
            
            let filteredOrders = orders;
            if (status !== 'all') {
                filteredOrders = orders.filter(o => o.status === status);
            }
            
            displayOrdersList(filteredOrders);
        }
        
        function displayOrdersList(orderList) {
            const ordersList = document.getElementById('ordersList');
            
            if (orderList.length === 0) {
                ordersList.innerHTML = '<p class="text-gray-500 text-center py-8">No orders found</p>';
                return;
            }
            
            let html = '<div class="space-y-4">';
            orderList.forEach(order => {
                const statusClass = getStatusClass(order.status);
                html += `
                    <div class="border rounded-lg p-6 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-lg font-semibold text-gray-900">${order.id}</h4>
                                <p class="text-gray-600">${order.customerName}</p>
                            </div>
                            <div class="text-right">
                                <span class="px-3 py-1 text-sm rounded ${statusClass}">${order.status.replace('-', ' ').toUpperCase()}</span>
                                <p class="text-sm text-gray-500 mt-1">Created: ${order.createdDate}</p>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <h5 class="font-medium text-gray-900 mb-2">Order Details</h5>
                                <p class="text-sm text-gray-600">Design: ${order.designNumber}</p>
                                <p class="text-sm text-gray-600">Meters: ${order.metersCount}m</p>
                                <p class="text-sm text-gray-600">Repeat Size: ${order.repeatSize || 'N/A'}</p>
                            </div>
                            <div>
                                <h5 class="font-medium text-gray-900 mb-2">Fabric Details</h5>
                                <p class="text-sm text-gray-600">Type: ${order.fabricType}</p>
                                <p class="text-sm text-gray-600">Color: ${order.fabricColor}</p>
                                <p class="text-sm text-gray-600">Yarn Code: ${order.yarnCode || 'N/A'}</p>
                            </div>
                            <div>
                                <h5 class="font-medium text-gray-900 mb-2">Production</h5>
                                <p class="text-sm text-gray-600">Machine: ${order.assignedMachine}</p>
                                <p class="text-sm text-gray-600">Placement: ${order.embroideryPlacement}</p>
                                <p class="text-sm text-gray-600">Est. Completion: ${order.estimatedCompletion}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="viewJobCard('${order.id}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">View Job Card</button>
                            <button onclick="updateOrderStatus('${order.id}')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">Update Status</button>
                            <button onclick="editOrder('${order.id}')" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 text-sm">Edit</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            ordersList.innerHTML = html;
        }
        
        function getStatusClass(status) {
            switch(status) {
                case 'pending-approval': return 'bg-yellow-100 text-yellow-800';
                case 'production': return 'bg-blue-100 text-blue-800';
                case 'quality-check': return 'bg-orange-100 text-orange-800';
                case 'complete': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        // Job Card functions
        window.viewJobCard = function(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            const jobCardContent = document.getElementById('jobCardContent');
            jobCardContent.innerHTML = generateJobCardHTML(order);
            
            document.getElementById('jobCardModal').classList.remove('hidden');
            document.getElementById('jobCardModal').classList.add('flex');
        }
        
        window.closeJobCard = function() {
            document.getElementById('jobCardModal').classList.add('hidden');
            document.getElementById('jobCardModal').classList.remove('flex');
        }
        
        window.printJobCard = function() {
            const printContent = document.getElementById('jobCardContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Job Card - ${document.getElementById('jobCardContent').querySelector('h1').textContent}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
                        @page { size: A4; margin: 20mm; }
                        .no-print { display: none; }
                    </style>
                </head>
                <body>${printContent}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        window.saveJobCard = function() {
            try {
                // Get the current order from the job card
                const jobCardElement = document.getElementById('jobCardContent');
                const orderIdElement = jobCardElement.querySelector('.bg-blue-100');
                
                if (!orderIdElement) {
                    alert('Error: Could not find order information');
                    return;
                }
                
                const orderId = orderIdElement.textContent.replace('Order #', '');
                const order = orders.find(o => o.id === orderId);
                
                if (!order) {
                    alert('Error: Order not found');
                    return;
                }
                
                // Check if jsPDF is available
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('jsPDF library not available');
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                // Add title and header
                doc.setFontSize(22);
                doc.setFont(undefined, 'bold');
                doc.text('SCHIFFLI EMBROIDERY', 105, 20, { align: 'center' });
                
                doc.setFontSize(18);
                doc.text('PRODUCTION JOB CARD', 105, 30, { align: 'center' });
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                doc.text(`Order #${order.id}`, 105, 45, { align: 'center' });
                
                // Add order details section
                let yPos = 65;
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('ORDER DETAILS:', 20, yPos);
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                yPos += 10;
                doc.text(`Customer: ${order.customerName}`, 25, yPos);
                yPos += 8;
                doc.text(`Design Number: ${order.designNumber}`, 25, yPos);
                yPos += 8;
                doc.text(`Meters to Produce: ${order.metersCount}m`, 25, yPos);
                yPos += 8;
                doc.text(`Repeat Size: ${order.repeatSize || 'N/A'}`, 25, yPos);
                yPos += 8;
                doc.text(`Order Date: ${order.createdDate}`, 25, yPos);
                
                // Add production specs section
                yPos += 20;
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('PRODUCTION SPECIFICATIONS:', 20, yPos);
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                yPos += 10;
                doc.text(`Fabric Type: ${order.fabricType}`, 25, yPos);
                yPos += 8;
                doc.text(`Fabric Color: ${order.fabricColor}`, 25, yPos);
                yPos += 8;
                doc.text(`Yarn Code: ${order.yarnCode || 'N/A'}`, 25, yPos);
                yPos += 8;
                doc.text(`Embroidery Placement: ${order.embroideryPlacement}`, 25, yPos);
                yPos += 8;
                doc.text(`Assigned Machine: ${order.assignedMachine}`, 25, yPos);
                
                // Add workflow checklist
                yPos += 20;
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('PRODUCTION WORKFLOW:', 20, yPos);
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                yPos += 12;
                
                const checklistItems = [
                    '‚òê Fabric inspection completed',
                    '‚òê Design file loaded & verified',
                    '‚òê Thread colors matched',
                    '‚òê Machine setup completed',
                    '‚òê Test sample approved',
                    '‚òê Production started',
                    '‚òê Quality checks passed',
                    '‚òê Final inspection done'
                ];
                
                checklistItems.forEach(item => {
                    doc.text(item, 25, yPos);
                    yPos += 7;
                });
                
                // Add signature section
                yPos += 20;
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('SIGNATURES:', 20, yPos);
                
                yPos += 20;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Operator: ________________________', 20, yPos);
                doc.text('Quality Control: ________________________', 110, yPos);
                
                yPos += 15;
                doc.text('Supervisor: ________________________', 20, yPos);
                doc.text('Date: ________________________', 110, yPos);
                
                // Add footer
                yPos += 25;
                doc.setFontSize(8);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 105, yPos, { align: 'center' });
                doc.text('Schiffli Production Manager Pro', 105, yPos + 5, { align: 'center' });
                
                // Save the PDF
                doc.save(`JobCard_${order.id}_${new Date().toISOString().split('T')[0]}.pdf`);
                
                alert('‚úÖ Job Card PDF saved successfully!');
                
            } catch (error) {
                console.error('PDF generation error:', error);
                
                // Fallback: Create a detailed text summary
                const jobCardElement = document.getElementById('jobCardContent');
                const orderIdElement = jobCardElement.querySelector('.bg-blue-100');
                const orderId = orderIdElement ? orderIdElement.textContent.replace('Order #', '') : 'Unknown';
                const order = orders.find(o => o.id === orderId);
                
                if (order) {
                    const jobCardText = `
SCHIFFLI EMBROIDERY - JOB CARD
Order #${order.id}

ORDER DETAILS:
Customer: ${order.customerName}
Design Number: ${order.designNumber}
Meters: ${order.metersCount}m
Repeat Size: ${order.repeatSize || 'N/A'}
Order Date: ${order.createdDate}

PRODUCTION SPECIFICATIONS:
Fabric: ${order.fabricType}
Color: ${order.fabricColor}
Yarn Code: ${order.yarnCode || 'N/A'}
Placement: ${order.embroideryPlacement}
Machine: ${order.assignedMachine}

WORKFLOW CHECKLIST:
‚òê Fabric inspection completed
‚òê Design file loaded & verified
‚òê Thread colors matched
‚òê Machine setup completed
‚òê Test sample approved
‚òê Production started
‚òê Quality checks passed
‚òê Final inspection done

Generated: ${new Date().toLocaleString()}
                    `;
                    
                    // Create downloadable text file
                    const blob = new Blob([jobCardText], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `JobCard_${order.id}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    alert('üìÑ Job Card saved as text file!\n\nPDF generation not available in this environment, but your job card has been downloaded as a text file.');
                } else {
                    alert('‚ùå Error: Could not generate job card. Order information not found.');
                }
            }
        }
        
        function generateJobCardHTML(order) {
            const designImageSrc = order.designImage || '';
            return `
                <div class="bg-white p-8 max-w-4xl mx-auto" style="font-family: Arial, sans-serif; width: 210mm; min-height: 297mm;">
                    <!-- Header -->
                    <div class="text-center border-b-2 border-black pb-4 mb-6">
                        <h1 class="text-3xl font-bold mb-2">SCHIFFLI EMBROIDERY</h1>
                        <h2 class="text-xl font-semibold">PRODUCTION JOB CARD</h2>
                        <div class="mt-2 text-sm">
                            <span class="bg-blue-100 px-3 py-1 rounded">Order #${order.id}</span>
                        </div>
                    </div>

                    <!-- Main Content Grid: Left Details, Right Design -->
                    <div class="grid grid-cols-2 gap-8 mb-6" style="min-height: 400px;">
                        <!-- Left Column - All Details -->
                        <div class="space-y-6">
                            <!-- Order Details -->
                            <div class="space-y-4">
                                <div class="border-b pb-2">
                                    <h3 class="font-bold text-lg text-blue-600">ORDER DETAILS</h3>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex">
                                        <span class="font-semibold w-32">Customer:</span>
                                        <span class="border-b border-dotted flex-1">${order.customerName}</span>
                                    </div>
                                    <div class="flex">
                                        <span class="font-semibold w-32">Design No:</span>
                                        <span class="border-b border-dotted flex-1">${order.designNumber}</span>
                                    </div>
                                    <div class="flex">
                                        <span class="font-semibold w-32">Meters:</span>
                                        <span class="border-b border-dotted flex-1">${order.metersCount}m</span>
                                    </div>
                                    <div class="flex">
                                        <span class="font-semibold w-32">Repeat Size:</span>
                                        <span class="border-b border-dotted flex-1">${order.repeatSize || 'N/A'}</span>
                                    </div>
                                    <div class="flex">
                                        <span class="font-semibold w-32">Order Date:</span>
                                        <span class="border-b border-dotted flex-1">${order.createdDate}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Production Specs -->
                            <div class="space-y-4">
                                <div class="border-b pb-2">
                                    <h3 class="font-bold text-lg text-green-600">PRODUCTION SPECS</h3>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex">
                                        <span class="font-semibold w-32">Fabric:</span>
                                        <span class="border-b border-dotted flex-1">${order.fabricType}</span>
                                    </div>
                                    <div class="flex">
                                        <span class="font-semibold w-32">Color:</span>
                                        <span class="border-b border-dotted flex-1">${order.fabricColor}</span>
                                    </div>
                                    <div class="flex">
                                        <span class="font-semibold w-32">Yarn Code:</span>
                                        <span class="border-b border-dotted flex-1">${order.yarnCode || 'N/A'}</span>
                                    </div>
                                    <div class="flex">
                                        <span class="font-semibold w-32">Placement:</span>
                                        <span class="border-b border-dotted flex-1">${order.embroideryPlacement}</span>
                                    </div>
                                    <div class="flex">
                                        <span class="font-semibold w-32">Machine:</span>
                                        <span class="border-b border-dotted flex-1">${order.assignedMachine}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column - Design Preview -->
                        <div class="space-y-4">
                            <div class="border-b pb-2">
                                <h3 class="font-bold text-xl text-purple-600">DESIGN PREVIEW</h3>
                            </div>
                            <div class="border-4 border-solid border-purple-300 bg-white rounded-lg shadow-lg flex items-center justify-center" style="width: 100%; height: 450px;">
                                ${designImageSrc ? 
                                    `<img src="${designImageSrc}" alt="Design Preview" style="max-width: 95%; max-height: 95%; object-fit: contain; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                     <div style="display: none;" class="text-center text-gray-700">
                                        <div class="text-8xl mb-6">üé®</div>
                                        <p class="text-2xl font-bold mb-2">Design Image</p>
                                        <p class="text-lg text-red-600 mb-4">Failed to load</p>
                                        <div class="bg-purple-100 p-4 rounded-lg">
                                            <p class="text-lg font-semibold text-purple-800">Design: ${order.designNumber}</p>
                                            <p class="text-sm text-purple-600 mt-1">Please check image file</p>
                                        </div>
                                     </div>` :
                                    `<div class="text-center text-gray-700">
                                        <div class="text-8xl mb-6">üé®</div>
                                        <p class="text-2xl font-bold mb-2">Design Image Area</p>
                                        <p class="text-lg text-gray-600 mb-4">(Upload design image for preview)</p>
                                        <div class="bg-purple-100 p-6 rounded-lg">
                                            <p class="text-xl font-bold text-purple-800">Design: ${order.designNumber}</p>
                                            <p class="text-sm text-purple-600 mt-2">Image will appear here once uploaded</p>
                                        </div>
                                     </div>`
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Production Workflow -->
                    <div class="mb-6">
                        <h3 class="font-bold text-lg text-orange-600 border-b pb-2 mb-4">PRODUCTION WORKFLOW</h3>
                        <div class="grid grid-cols-2 gap-6">
                            <div class="space-y-3">
                                <h4 class="font-semibold text-gray-700">PREPARATION</h4>
                                <div class="space-y-2 text-sm">
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" class="w-4 h-4">
                                        <span>Fabric inspection completed</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" class="w-4 h-4">
                                        <span>Design file loaded & verified</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" class="w-4 h-4">
                                        <span>Thread colors matched</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" class="w-4 h-4">
                                        <span>Machine setup completed</span>
                                    </label>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <h4 class="font-semibold text-gray-700">PRODUCTION</h4>
                                <div class="space-y-2 text-sm">
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" class="w-4 h-4">
                                        <span>Test sample approved</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" class="w-4 h-4">
                                        <span>Production started</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" class="w-4 h-4">
                                        <span>Quality checks passed</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" class="w-4 h-4">
                                        <span>Final inspection done</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Signatures -->
                    <div class="grid grid-cols-3 gap-8 mt-8">
                        <div class="text-center">
                            <div class="border-t-2 border-black pt-2 mt-12">
                                <p class="font-bold">OPERATOR</p>
                                <p class="text-xs text-gray-600">Name & Signature</p>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="border-t-2 border-black pt-2 mt-12">
                                <p class="font-bold">QUALITY CONTROL</p>
                                <p class="text-xs text-gray-600">Name & Signature</p>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="border-t-2 border-black pt-2 mt-12">
                                <p class="font-bold">SUPERVISOR</p>
                                <p class="text-xs text-gray-600">Name & Signature</p>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="text-center text-xs text-gray-500 mt-8 pt-4 border-t">
                        <p>Generated by Schiffli Production Manager Pro | ${new Date().toLocaleString()}</p>
                        <p>This is an official production document - Handle with care</p>
                    </div>
                </div>
            `;
        }
        
        // Custom placement toggle
        window.toggleCustomPlacement = function() {
            const placement = document.getElementById('embroideryPlacement').value;
            const customDiv = document.getElementById('customPlacementDiv');
            
            if (placement === 'Custom') {
                customDiv.classList.remove('hidden');
                document.getElementById('customPlacement').required = true;
            } else {
                customDiv.classList.add('hidden');
                document.getElementById('customPlacement').required = false;
            }
        }
        
        // Image upload handler
        window.handleImageUpload = function(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    const previewImg = document.getElementById('previewImg');
                    previewImg.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Update order status with proper modal
        window.updateOrderStatus = function(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            showStatusUpdateModal(order);
        }
        
        function showStatusUpdateModal(order) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-md w-full mx-4">
                    <div class="p-6 border-b">
                        <h3 class="text-xl font-semibold">Update Order Status</h3>
                        <p class="text-sm text-gray-600 mt-1">Order ID: ${order.id}</p>
                    </div>
                    <div class="p-6">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Current Status</label>
                            <p class="text-lg font-semibold text-blue-600">${order.status.replace('-', ' ').toUpperCase()}</p>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">New Status</label>
                            <select id="newStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="pending-approval" ${order.status === 'pending-approval' ? 'selected' : ''}>Pending Approval</option>
                                <option value="production" ${order.status === 'production' ? 'selected' : ''}>In Production</option>
                                <option value="quality-check" ${order.status === 'quality-check' ? 'selected' : ''}>Quality Check</option>
                                <option value="complete" ${order.status === 'complete' ? 'selected' : ''}>Complete</option>
                            </select>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                            <textarea id="statusNotes" rows="3" placeholder="Add any notes about this status change..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        <div class="flex gap-4">
                            <button onclick="confirmStatusUpdate('${order.id}')" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update Status</button>
                            <button onclick="closeStatusModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentStatusModal = modal;
        }
        
        window.confirmStatusUpdate = function(orderId) {
            const newStatus = document.getElementById('newStatus').value;
            const notes = document.getElementById('statusNotes').value;
            
            const order = orders.find(o => o.id === orderId);
            if (order && newStatus !== order.status) {
                order.status = newStatus;
                order.workflowStage = newStatus;
                order.lastUpdated = new Date().toLocaleString();
                order.updatedBy = currentUser.name;
                
                if (notes) {
                    if (!order.statusHistory) order.statusHistory = [];
                    order.statusHistory.push({
                        status: newStatus,
                        notes: notes,
                        updatedBy: currentUser.name,
                        updatedDate: new Date().toLocaleString()
                    });
                }
                
                saveData();
                updateDashboard();
                updateRecentOrders();
                
                // Refresh current view
                if (!document.getElementById('ordersSection').classList.contains('hidden')) {
                    filterOrders('all');
                }
                
                alert(`Order ${orderId} status updated to: ${newStatus.replace('-', ' ').toUpperCase()}`);
            }
            
            closeStatusModal();
        }
        
        window.closeStatusModal = function() {
            if (window.currentStatusModal) {
                document.body.removeChild(window.currentStatusModal);
                window.currentStatusModal = null;
            }
        }
        
        // Edit order function with proper modal
        window.editOrder = function(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            showEditOrderModal(order);
        }
        
        function showEditOrderModal(order) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-4xl w-full mx-4 my-8">
                    <div class="p-6 border-b">
                        <h3 class="text-xl font-semibold">Edit Order</h3>
                        <p class="text-sm text-gray-600 mt-1">Order ID: ${order.id}</p>
                    </div>
                    <div class="p-6 max-h-96 overflow-y-auto">
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <h4 class="font-semibold text-gray-900 border-b pb-2">Order Details</h4>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Customer Name</label>
                                    <input type="text" id="editCustomerName" value="${order.customerName}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Design Number</label>
                                    <input type="text" id="editDesignNumber" value="${order.designNumber}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Meters to Produce</label>
                                    <input type="number" id="editMetersCount" value="${order.metersCount}" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Repeat Size</label>
                                    <input type="text" id="editRepeatSize" value="${order.repeatSize || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            <div class="space-y-4">
                                <h4 class="font-semibold text-gray-900 border-b pb-2">Fabric & Production</h4>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Fabric Type</label>
                                    <select id="editFabricType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="Cotton" ${order.fabricType === 'Cotton' ? 'selected' : ''}>Cotton</option>
                                        <option value="Polyester" ${order.fabricType === 'Polyester' ? 'selected' : ''}>Polyester</option>
                                        <option value="Silk" ${order.fabricType === 'Silk' ? 'selected' : ''}>Silk</option>
                                        <option value="Linen" ${order.fabricType === 'Linen' ? 'selected' : ''}>Linen</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Fabric Color</label>
                                    <input type="text" id="editFabricColor" value="${order.fabricColor}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Embroidery Placement</label>
                                    <input type="text" id="editEmbroideryPlacement" value="${order.embroideryPlacement}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Yarn Code</label>
                                    <input type="text" id="editYarnCode" value="${order.yarnCode || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Assigned Machine</label>
                                    <select id="editAssignedMachine" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="Machine-01" ${order.assignedMachine === 'Machine-01' ? 'selected' : ''}>Machine-01</option>
                                        <option value="Machine-02" ${order.assignedMachine === 'Machine-02' ? 'selected' : ''}>Machine-02</option>
                                        <option value="Machine-03" ${order.assignedMachine === 'Machine-03' ? 'selected' : ''}>Machine-03</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 border-t flex gap-4">
                        <button onclick="saveOrderChanges('${order.id}')" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Changes</button>
                        <button onclick="closeEditModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentEditModal = modal;
        }
        
        window.saveOrderChanges = function(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            // Update order with new values
            order.customerName = document.getElementById('editCustomerName').value;
            order.designNumber = document.getElementById('editDesignNumber').value;
            order.metersCount = parseInt(document.getElementById('editMetersCount').value);
            order.repeatSize = document.getElementById('editRepeatSize').value;
            order.fabricType = document.getElementById('editFabricType').value;
            order.fabricColor = document.getElementById('editFabricColor').value;
            order.embroideryPlacement = document.getElementById('editEmbroideryPlacement').value;
            order.yarnCode = document.getElementById('editYarnCode').value;
            order.assignedMachine = document.getElementById('editAssignedMachine').value;
            order.lastUpdated = new Date().toLocaleString();
            order.updatedBy = currentUser.name;
            
            saveData();
            updateDashboard();
            updateRecentOrders();
            
            // Refresh current view
            if (!document.getElementById('ordersSection').classList.contains('hidden')) {
                filterOrders('all');
            }
            
            alert(`Order ${orderId} updated successfully!`);
            closeEditModal();
        }
        
        window.closeEditModal = function() {
            if (window.currentEditModal) {
                document.body.removeChild(window.currentEditModal);
                window.currentEditModal = null;
            }
        }
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');
            
            // Load data and initialize
            loadData();
            initializeUsers();
            initializeMachines();
            
            // Setup forms
            setupLoginForm();
            
            // Check if user is already logged in
            if (currentUser) {
                console.log('User already logged in:', currentUser.name);
                document.getElementById('loginModal').classList.add('hidden');
                updateUserInterface();
                updateDashboard();
                updateRecentOrders();
                showSection('dashboard');
            } else {
                console.log('No user logged in, showing login modal');
                document.getElementById('loginModal').classList.remove('hidden');
                document.getElementById('loginModal').classList.add('flex');
            }
            
            console.log('App initialized successfully');
            console.log('Available users:', users.length);
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'978bfcf3a05440f1',t:'MTc1NjgwNTQyMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
