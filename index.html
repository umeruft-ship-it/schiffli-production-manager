<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schiffli Production Manager Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .status-pending { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
        .status-production { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); }
        .status-complete { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); }
        .status-approved { background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); }
        .status-quality-check { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
        .print-hidden { display: none !important; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }
        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .sync-online { background: #10b981; color: white; }
        .sync-offline { background: #f59e0b; color: white; }
        .sync-error { background: #ef4444; color: white; }
        .chart-container { height: 300px; }
        .efficiency-meter {
            background: conic-gradient(from 0deg, #ef4444 0deg 60deg, #f59e0b 60deg 120deg, #10b981 120deg 360deg);
            border-radius: 50%;
            position: relative;
        }
        .efficiency-inner {
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Sync Status Indicator -->
    <div id="syncStatus" class="sync-status sync-offline">
        <span id="syncText">üíæ Ready - Using Local Storage</span>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-md w-full mx-4">
            <div class="p-6 border-b">
                <h3 class="text-xl font-semibold text-center">Schiffli Production Manager</h3>
                <p class="text-sm text-gray-600 text-center mt-1">Please login to continue</p>
            </div>
            <div class="p-6">
                <form id="loginForm">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mobile Number</label>
                            <input type="tel" id="mobileNumber" required placeholder="Enter 10-digit mobile number" 
                                   pattern="[0-9]{10}" maxlength="10" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" id="password" required placeholder="Enter password" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="rememberMe" class="mr-2">
                            <label for="rememberMe" class="text-sm text-gray-600">Remember me</label>
                        </div>
                    </div>
                    <div class="mt-6">
                        <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">Login</button>
                    </div>
                </form>
                <div class="mt-4 text-center">
                    <button onclick="showDemoCredentials()" class="text-sm text-blue-600 hover:text-blue-700">View Demo Credentials</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Demo Credentials Modal -->
    <div id="demoCredentialsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-lg w-full mx-4">
            <div class="p-6 border-b">
                <h3 class="text-xl font-semibold">Demo Login Credentials</h3>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-medium text-blue-900">CEO/Admin</h4>
                        <p class="text-sm text-blue-700">Mobile: 9876543210</p>
                        <p class="text-sm text-blue-700">Password: admin123</p>
                        <p class="text-xs text-blue-600 mt-1">Full access to all features</p>
                    </div>
                    <div class="p-4 bg-green-50 rounded-lg">
                        <h4 class="font-medium text-green-900">Production Manager</h4>
                        <p class="text-sm text-green-700">Mobile: 9876543211</p>
                        <p class="text-sm text-green-700">Password: manager123</p>
                        <p class="text-xs text-green-600 mt-1">Production & workflow management</p>
                    </div>
                    <div class="p-4 bg-yellow-50 rounded-lg">
                        <h4 class="font-medium text-yellow-900">Operator</h4>
                        <p class="text-sm text-yellow-700">Mobile: 9876543212</p>
                        <p class="text-sm text-yellow-700">Password: operator123</p>
                        <p class="text-xs text-yellow-600 mt-1">View orders & update status</p>
                    </div>
                    <div class="p-4 bg-purple-50 rounded-lg">
                        <h4 class="font-medium text-purple-900">Quality Control</h4>
                        <p class="text-sm text-purple-700">Mobile: 9876543213</p>
                        <p class="text-sm text-purple-700">Password: qc123</p>
                        <p class="text-xs text-purple-600 mt-1">Quality checks & approvals</p>
                    </div>
                </div>
                <div class="mt-6 flex gap-4">
                    <button onclick="closeDemoCredentials()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Close</button>
                    <button onclick="fillDemoCredentials('admin')" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Use Admin Login</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-900">Schiffli Production Manager Pro</h1>
                <div class="flex gap-2 items-center flex-wrap">
                    <button onclick="showSection('dashboard')" id="dashboardBtn" class="nav-btn px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">Dashboard</button>
                    <button onclick="showSection('analytics')" id="analyticsBtn" class="nav-btn px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm">Analytics</button>
                    <button onclick="showSection('production')" id="productionBtn" class="nav-btn px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm">Production</button>
                    <button onclick="showSection('workflow')" id="workflowBtn" class="nav-btn px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm">Workflow</button>
                    <button onclick="showSection('orders')" id="ordersBtn" class="nav-btn px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm">Orders</button>
                    <button onclick="showSection('newOrder')" id="newOrderBtn" class="nav-btn px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm">New Order</button>
                    <button onclick="toggleGoogleDriveSync()" id="syncBtn" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                        <span id="syncBtnText">üì§ Deploy Info</span>
                    </button>
                    
                    <!-- User Profile -->
                    <div class="flex items-center gap-3 ml-4 pl-4 border-l border-gray-300">
                        <div class="text-right">
                            <p id="userDisplayName" class="text-sm font-medium text-gray-900">User</p>
                            <p id="userRole" class="text-xs text-gray-600">Role</p>
                        </div>
                        <div class="relative">
                            <button onclick="toggleUserMenu()" class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-medium hover:bg-blue-700">
                                <span id="userInitials">U</span>
                            </button>
                            <div id="userMenu" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border hidden z-50">
                                <div class="p-3 border-b">
                                    <p class="text-sm font-medium text-gray-900" id="menuUserName">User</p>
                                    <p class="text-xs text-gray-600" id="menuUserMobile">Mobile</p>
                                </div>
                                <div class="py-1">
                                    <button onclick="showUserProfile()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Profile Settings</button>
                                    <button onclick="showUserManagement()" id="userManagementBtn" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hidden">User Management</button>
                                    <button onclick="logout()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">Logout</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Section -->
    <div id="dashboardSection" class="max-w-7xl mx-auto px-6 py-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-8">CEO Dashboard</h2>
        
        <!-- Stats Cards -->
        <div class="grid md:grid-cols-4 gap-6 mb-8">
            <div onclick="filterDashboardOrders('all')" class="bg-white rounded-lg p-6 shadow-sm border cursor-pointer hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Total Orders</p>
                        <p id="totalOrders" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <span class="text-blue-600 text-xl">üìã</span>
                    </div>
                </div>
            </div>
            
            <div onclick="filterDashboardOrders('production')" class="bg-white rounded-lg p-6 shadow-sm border cursor-pointer hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">In Production</p>
                        <p id="inProductionCount" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <span class="text-blue-600 text-xl">‚öôÔ∏è</span>
                    </div>
                </div>
            </div>
            
            <div onclick="filterDashboardOrders('complete')" class="bg-white rounded-lg p-6 shadow-sm border cursor-pointer hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Completed</p>
                        <p id="completedCount" class="text-2xl font-bold text-green-600">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <span class="text-green-600 text-xl">‚úÖ</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm border">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Efficiency</p>
                        <p id="overallEfficiency" class="text-2xl font-bold text-purple-600">0%</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                        <span class="text-purple-600 text-xl">üìä</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg p-6 shadow-sm border">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h3>
                <div class="space-y-3">
                    <button onclick="showSection('newOrder')" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">Create New Order</button>
                    <button onclick="generateProductionReport()" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">Generate Report</button>
                    <button onclick="showSection('production')" class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">Machine Status</button>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm border">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Today's Metrics</h3>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600 text-sm">Orders Created:</span>
                        <span id="todayOrders" class="font-medium">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 text-sm">Meters Produced:</span>
                        <span id="todayMeters" class="font-medium">0m</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 text-sm">Active Machines:</span>
                        <span id="activeMachines" class="font-medium">0</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm border">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Alerts & Notifications</h3>
                <div id="alertsList" class="space-y-2">
                    <p class="text-gray-500 text-sm">No alerts</p>
                </div>
            </div>
        </div>

        <!-- Recent Orders -->
        <div class="bg-white rounded-lg shadow-sm border">
            <div class="p-6 border-b">
                <h3 class="text-lg font-semibold text-gray-900">Recent Orders</h3>
            </div>
            <div id="recentOrdersList" class="p-6">
                <p class="text-gray-500 text-center py-8">No orders yet</p>
            </div>
        </div>

        <!-- Filtered Orders Section -->
        <div id="filteredOrdersSection" class="bg-white rounded-lg shadow-sm border mt-8 hidden">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 id="filteredOrdersTitle" class="text-lg font-semibold text-gray-900">All Orders</h3>
                    <button onclick="hideDashboardFilter()" class="text-gray-500 hover:text-gray-700">
                        <span class="text-xl">√ó</span>
                    </button>
                </div>
            </div>
            <div id="filteredOrdersList" class="p-6">
                <p class="text-gray-500 text-center py-8">No orders found</p>
            </div>
        </div>
    </div>

    <!-- Analytics Section -->
    <div id="analyticsSection" class="max-w-7xl mx-auto px-6 py-8 hidden">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900">Advanced Analytics & Reports</h2>
            <div class="flex gap-4">
                <select id="analyticsTimeframe" onchange="updateAnalytics()" class="px-4 py-2 border border-gray-300 rounded-lg">
                    <option value="7">Last 7 Days</option>
                    <option value="30">Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                    <option value="365">Last Year</option>
                </select>
                <button onclick="exportAnalyticsReport()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Export Report</button>
            </div>
        </div>

        <!-- Analytics Cards -->
        <div class="grid md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg p-6 shadow-sm border">
                <h3 class="text-sm font-medium text-gray-600 mb-2">Production Efficiency</h3>
                <div class="flex items-center">
                    <div class="efficiency-meter w-16 h-16 mr-4">
                        <div class="efficiency-inner w-12 h-12 flex items-center justify-center">
                            <span id="efficiencyPercent" class="text-sm font-bold">85%</span>
                        </div>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-gray-900" id="analyticsEfficiency">85%</p>
                        <p class="text-xs text-green-600">‚Üó +5% vs last period</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm border">
                <h3 class="text-sm font-medium text-gray-600 mb-2">Average Order Time</h3>
                <p class="text-2xl font-bold text-gray-900" id="avgOrderTime">2.3 days</p>
                <p class="text-xs text-green-600">‚Üó 15% faster</p>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm border">
                <h3 class="text-sm font-medium text-gray-600 mb-2">Machine Utilization</h3>
                <p class="text-2xl font-bold text-gray-900" id="machineUtilization">78%</p>
                <p class="text-xs text-yellow-600">‚Üí Same as last period</p>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm border">
                <h3 class="text-sm font-medium text-gray-600 mb-2">Quality Score</h3>
                <p class="text-2xl font-bold text-gray-900" id="qualityScore">94%</p>
                <p class="text-xs text-green-600">‚Üó +2% improvement</p>
            </div>
        </div>

        <!-- Reports Grid -->
        <div class="grid md:grid-cols-2 gap-8">
            <!-- Production Reports -->
            <div class="bg-white rounded-lg shadow-sm border">
                <div class="p-6 border-b">
                    <h3 class="text-lg font-semibold text-gray-900">Production Reports</h3>
                </div>
                <div class="p-6 space-y-4">
                    <div class="flex justify-between items-center p-4 border rounded-lg hover:bg-gray-50 cursor-pointer" onclick="generateWeeklyReport()">
                        <div>
                            <h4 class="font-medium">Weekly Production Summary</h4>
                            <p class="text-sm text-gray-600">Orders, efficiency, and machine usage</p>
                        </div>
                        <span class="text-blue-600">üìä</span>
                    </div>
                    
                    <div class="flex justify-between items-center p-4 border rounded-lg hover:bg-gray-50 cursor-pointer" onclick="generateMonthlyReport()">
                        <div>
                            <h4 class="font-medium">Monthly Analysis</h4>
                            <p class="text-sm text-gray-600">Comprehensive monthly breakdown</p>
                        </div>
                        <span class="text-blue-600">üìà</span>
                    </div>
                    
                    <div class="flex justify-between items-center p-4 border rounded-lg hover:bg-gray-50 cursor-pointer" onclick="generateCustomerReport()">
                        <div>
                            <h4 class="font-medium">Customer Order History</h4>
                            <p class="text-sm text-gray-600">Individual customer analytics</p>
                        </div>
                        <span class="text-blue-600">üë•</span>
                    </div>
                </div>
            </div>

            <!-- Predictive Analytics -->
            <div class="bg-white rounded-lg shadow-sm border">
                <div class="p-6 border-b">
                    <h3 class="text-lg font-semibold text-gray-900">Predictive Analytics</h3>
                </div>
                <div class="p-6 space-y-4">
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-medium text-blue-900">Production Forecast</h4>
                        <p class="text-sm text-blue-700 mt-1">Based on current trends, expect 15% increase in orders next month</p>
                        <div class="mt-2">
                            <div class="flex justify-between text-xs text-blue-600">
                                <span>Confidence: 87%</span>
                                <span>Trend: ‚Üó Increasing</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-yellow-50 rounded-lg">
                        <h4 class="font-medium text-yellow-900">Machine Maintenance Alert</h4>
                        <p class="text-sm text-yellow-700 mt-1">Machine-03 and Machine-07 may need maintenance within 2 weeks</p>
                        <div class="mt-2">
                            <div class="flex justify-between text-xs text-yellow-600">
                                <span>Priority: Medium</span>
                                <span>Schedule: Recommended</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-green-50 rounded-lg">
                        <h4 class="font-medium text-green-900">Efficiency Optimization</h4>
                        <p class="text-sm text-green-700 mt-1">Optimal production schedule could improve efficiency by 12%</p>
                        <div class="mt-2">
                            <div class="flex justify-between text-xs text-green-600">
                                <span>Impact: High</span>
                                <span>Implementation: Easy</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Production Management Section -->
    <div id="productionSection" class="max-w-7xl mx-auto px-6 py-8 hidden">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900">Production Management</h2>
            <div class="flex gap-4">
                <button onclick="scheduleMaintenance()" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">Schedule Maintenance</button>
                <button onclick="updateYarnInventory()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Update Inventory</button>
            </div>
        </div>

        <!-- Machine Status Grid -->
        <div class="grid md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-sm border">
                <div class="p-6 border-b">
                    <h3 class="text-lg font-semibold text-gray-900">Machine Status</h3>
                </div>
                <div id="machineStatusList" class="p-6">
                    <!-- Machine status will be populated here -->
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm border">
                <div class="p-6 border-b">
                    <h3 class="text-lg font-semibold text-gray-900">Yarn Inventory</h3>
                </div>
                <div id="yarnInventoryList" class="p-6">
                    <!-- Yarn inventory will be populated here -->
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm border">
                <div class="p-6 border-b">
                    <h3 class="text-lg font-semibold text-gray-900">Production Estimates</h3>
                </div>
                <div id="productionEstimates" class="p-6">
                    <!-- Production estimates will be populated here -->
                </div>
            </div>
        </div>

        <!-- Batch Processing -->
        <div class="bg-white rounded-lg shadow-sm border">
            <div class="p-6 border-b">
                <h3 class="text-lg font-semibold text-gray-900">Batch Processing</h3>
            </div>
            <div class="p-6">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-medium mb-4">Create Production Batch</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Batch Name</label>
                                <input type="text" id="batchName" placeholder="e.g., Morning Batch - Cotton Orders" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Select Orders for Batch</label>
                                <div id="batchOrderSelection" class="max-h-40 overflow-y-auto border border-gray-300 rounded-lg p-3">
                                    <!-- Orders will be populated here -->
                                </div>
                            </div>
                            <button onclick="createBatch()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Create Batch</button>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-medium mb-4">Active Batches</h4>
                        <div id="activeBatchesList" class="space-y-3">
                            <p class="text-gray-500 text-sm">No active batches</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Workflow Management Section -->
    <div id="workflowSection" class="max-w-7xl mx-auto px-6 py-8 hidden">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900">Workflow Management</h2>
            <button onclick="showApprovalQueue()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Approval Queue</button>
        </div>

        <!-- Workflow Status -->
        <div class="grid md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg p-6 shadow-sm border text-center">
                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-yellow-600 text-2xl">‚è≥</span>
                </div>
                <h3 class="font-semibold text-gray-900">Pending Approval</h3>
                <p id="pendingApprovalCount" class="text-2xl font-bold text-yellow-600">0</p>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm border text-center">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-blue-600 text-2xl">‚úÖ</span>
                </div>
                <h3 class="font-semibold text-gray-900">Approved</h3>
                <p id="approvedCount" class="text-2xl font-bold text-blue-600">0</p>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm border text-center">
                <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-orange-600 text-2xl">üîç</span>
                </div>
                <h3 class="font-semibold text-gray-900">Quality Check</h3>
                <p id="qualityCheckCount" class="text-2xl font-bold text-orange-600">0</p>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm border text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-green-600 text-2xl">üì¶</span>
                </div>
                <h3 class="font-semibold text-gray-900">Ready for Delivery</h3>
                <p id="readyDeliveryCount" class="text-2xl font-bold text-green-600">0</p>
            </div>
        </div>

        <!-- Workflow Orders -->
        <div class="bg-white rounded-lg shadow-sm border">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-900">Order Workflow Status</h3>
                    <select id="workflowFilter" onchange="filterWorkflowOrders()" class="px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="all">All Stages</option>
                        <option value="pending-approval">Pending Approval</option>
                        <option value="approved">Approved</option>
                        <option value="production">In Production</option>
                        <option value="quality-check">Quality Check</option>
                        <option value="complete">Complete</option>
                    </select>
                </div>
            </div>
            <div id="workflowOrdersList" class="p-6">
                <!-- Workflow orders will be populated here -->
            </div>
        </div>
    </div>

    <!-- Orders Section -->
    <div id="ordersSection" class="max-w-7xl mx-auto px-6 py-8 hidden">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900">Production Orders</h2>
            <div class="flex gap-4">
                <select id="statusFilter" onchange="filterOrders()" class="px-4 py-2 border border-gray-300 rounded-lg">
                    <option value="all">All Status</option>
                    <option value="pending-approval">Pending Approval</option>
                    <option value="approved">Approved</option>
                    <option value="pending">Pending</option>
                    <option value="production">In Production</option>
                    <option value="quality-check">Quality Check</option>
                    <option value="complete">Complete</option>
                </select>
            </div>
        </div>
        
        <div id="ordersList" class="space-y-4">
            <p class="text-gray-500 text-center py-8">No orders found</p>
        </div>
    </div>

    <!-- User Management Section -->
    <div id="userManagementSection" class="max-w-7xl mx-auto px-6 py-8 hidden">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900">User Management</h2>
            <button onclick="showAddUserModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add New User</button>
        </div>
        
        <!-- User List -->
        <div class="bg-white rounded-lg shadow-sm border">
            <div class="p-6 border-b">
                <h3 class="text-lg font-semibold text-gray-900">System Users</h3>
            </div>
            <div id="usersList" class="p-6">
                <!-- Users will be populated here -->
            </div>
        </div>
    </div>

    <!-- User Profile Section -->
    <div id="userProfileSection" class="max-w-4xl mx-auto px-6 py-8 hidden">
        <h2 class="text-3xl font-bold text-gray-900 mb-8">Profile Settings</h2>
        
        <div class="bg-white rounded-lg shadow-sm border p-8">
            <form id="profileForm">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                        <input type="text" id="profileName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mobile Number</label>
                        <input type="tel" id="profileMobile" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                        <input type="text" id="profileRole" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                        <input type="text" id="profileDepartment" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                
                <div class="mt-6 border-t pt-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Change Password</h3>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Current Password</label>
                            <input type="password" id="currentPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                            <input type="password" id="newPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-4 mt-8">
                    <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">Update Profile</button>
                    <button type="button" onclick="showSection('dashboard')" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Order Section -->
    <div id="newOrderSection" class="max-w-4xl mx-auto px-6 py-8 hidden">
        <h2 class="text-3xl font-bold text-gray-900 mb-8">Create New Order</h2>
        
        <form id="orderForm" class="bg-white rounded-lg shadow-sm border p-8">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Order Details -->
                <div class="space-y-6">
                    <h3 class="text-lg font-semibold text-gray-900 border-b pb-2">Order Details</h3>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Order ID</label>
                        <input type="text" id="orderId" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" readonly>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Customer Name *</label>
                        <input type="text" id="customerName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lot Number</label>
                        <input type="text" id="lotNumber" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Design Number *</label>
                        <input type="text" id="designNumber" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Priority Level</label>
                        <select id="priorityLevel" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="normal">Normal</option>
                            <option value="high">High Priority</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </div>

                <!-- Fabric & Production Details -->
                <div class="space-y-6">
                    <h3 class="text-lg font-semibold text-gray-900 border-b pb-2">Fabric & Production</h3>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fabric Type *</label>
                        <select id="fabricType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select Fabric</option>
                            <option value="Cotton">Cotton</option>
                            <option value="Polyester">Polyester</option>
                            <option value="Silk">Silk</option>
                            <option value="Linen">Linen</option>
                            <option value="Blend">Cotton-Poly Blend</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fabric Color *</label>
                        <input type="text" id="fabricColor" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Yarn Code *</label>
                        <input type="text" id="yarnCode" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Meters to Produce *</label>
                        <input type="number" id="metersCount" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Estimated Completion (Days)</label>
                        <input type="number" id="estimatedDays" min="1" value="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <!-- Embroidery Details -->
                <div class="md:col-span-2 space-y-6">
                    <h3 class="text-lg font-semibold text-gray-900 border-b pb-2">Embroidery Details</h3>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Embroidery Placement *</label>
                            <select id="embroideryPlacement" required onchange="toggleCustomPlacement()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select Placement</option>
                                <option value="Front">Front</option>
                                <option value="Back">Back</option>
                                <option value="Sleeve">Sleeve</option>
                                <option value="Chest">Chest</option>
                                <option value="Collar">Collar</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        
                        <div id="customPlacementDiv" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Custom Placement Details</label>
                            <input type="text" id="customPlacement" placeholder="Enter custom placement details" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Repeat Size of Design *</label>
                            <input type="text" id="repeatSize" required placeholder="e.g., 10cm x 15cm" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Assigned Machine</label>
                            <select id="assignedMachine" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Auto-Assign</option>
                                <option value="Machine-01">Machine-01</option>
                                <option value="Machine-02">Machine-02</option>
                                <option value="Machine-03">Machine-03</option>
                                <option value="Machine-04">Machine-04</option>
                                <option value="Machine-05">Machine-05</option>
                                <option value="Machine-06">Machine-06</option>
                                <option value="Machine-07">Machine-07</option>
                                <option value="Machine-08">Machine-08</option>
                                <option value="Machine-09">Machine-09</option>
                                <option value="Machine-10">Machine-10</option>
                                <option value="Machine-11">Machine-11</option>
                                <option value="Machine-12">Machine-12</option>
                                <option value="Machine-13">Machine-13</option>
                                <option value="Machine-14">Machine-14</option>
                                <option value="Machine-15">Machine-15</option>
                                <option value="Machine-16">Machine-16</option>
                                <option value="Machine-17">Machine-17</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Design Image</label>
                        <input type="file" id="designImage" accept="image/*" onchange="previewImage()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <div id="imagePreview" class="mt-4 hidden">
                            <img id="previewImg" class="max-w-xs h-32 object-cover rounded-lg border">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4 mt-8">
                <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">Create Order</button>
                <button type="button" id="createAndViewBtn" onclick="createOrderAndViewJobCard()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">Create & View Job Card</button>
                <button type="button" onclick="resetForm()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">Reset</button>
            </div>
        </form>
    </div>

    <!-- Job Card Modal -->
    <div id="jobCardModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center no-print">
                <h3 class="text-xl font-semibold">Job Card</h3>
                <div class="flex gap-2">
                    <button onclick="saveJobCardAsPDF()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Save as PDF</button>
                    <button onclick="printJobCard()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Print PDF</button>
                    <button onclick="closeJobCard()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Close</button>
                </div>
            </div>
            <div id="jobCardContent" class="p-8">
                <!-- Job card content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-2xl w-full mx-4">
            <div class="p-6 border-b">
                <h3 class="text-xl font-semibold">Add New User</h3>
            </div>
            <div class="p-6">
                <form id="addUserForm">
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                            <input type="text" id="newUserName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mobile Number *</label>
                            <input type="tel" id="newUserMobile" required pattern="[0-9]{10}" maxlength="10" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Role *</label>
                            <select id="newUserRole" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="">Select Role</option>
                                <option value="admin">Admin</option>
                                <option value="manager">Production Manager</option>
                                <option value="operator">Operator</option>
                                <option value="qc">Quality Control</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                            <input type="text" id="newUserDepartment" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password *</label>
                            <input type="password" id="newUserPassword" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    <div class="flex gap-4 mt-6">
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add User</button>
                        <button type="button" onclick="closeAddUserModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Maintenance Modal -->
    <div id="maintenanceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-2xl w-full mx-4">
            <div class="p-6 border-b">
                <h3 class="text-xl font-semibold">Schedule Machine Maintenance</h3>
            </div>
            <div class="p-6">
                <form id="maintenanceForm">
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Machine</label>
                            <select id="maintenanceMachine" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="">Select Machine</option>
                                <option value="Machine-01">Machine-01</option>
                                <option value="Machine-02">Machine-02</option>
                                <option value="Machine-03">Machine-03</option>
                                <option value="Machine-04">Machine-04</option>
                                <option value="Machine-05">Machine-05</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Maintenance Date</label>
                            <input type="date" id="maintenanceDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Maintenance Type</label>
                            <select id="maintenanceType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="">Select Type</option>
                                <option value="routine">Routine Maintenance</option>
                                <option value="repair">Repair</option>
                                <option value="upgrade">Upgrade</option>
                                <option value="calibration">Calibration</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                            <textarea id="maintenanceNotes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
                        </div>
                    </div>
                    <div class="flex gap-4 mt-6">
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Schedule</button>
                        <button type="button" onclick="closeMaintenanceModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Enhanced data storage
        let orders = [];
        let dailyCounter = {};
        let machines = [];
        let yarnInventory = [];
        let maintenanceSchedule = [];
        let productionBatches = [];
        let users = [];
        let currentUser = null;
        
        // User roles and permissions
        const userRoles = {
            admin: {
                name: 'Admin',
                permissions: ['all'],
                sections: ['dashboard', 'analytics', 'production', 'workflow', 'orders', 'newOrder', 'userManagement']
            },
            manager: {
                name: 'Production Manager',
                permissions: ['view_all', 'manage_production', 'manage_workflow', 'create_orders', 'approve_orders'],
                sections: ['dashboard', 'analytics', 'production', 'workflow', 'orders', 'newOrder']
            },
            operator: {
                name: 'Operator',
                permissions: ['view_orders', 'update_status'],
                sections: ['dashboard', 'orders']
            },
            qc: {
                name: 'Quality Control',
                permissions: ['view_orders', 'quality_check', 'approve_quality'],
                sections: ['dashboard', 'workflow', 'orders']
            }
        };
        
        // Initialize enhanced data structures
        function initializeEnhancedData() {
            // Initialize users
            if (!users.length) {
                users = [
                    {
                        id: 'user_1',
                        name: 'Admin User',
                        mobile: '9876543210',
                        password: 'admin123',
                        role: 'admin',
                        department: 'Management',
                        createdDate: new Date().toLocaleDateString(),
                        lastLogin: null
                    },
                    {
                        id: 'user_2',
                        name: 'Production Manager',
                        mobile: '9876543211',
                        password: 'manager123',
                        role: 'manager',
                        department: 'Production',
                        createdDate: new Date().toLocaleDateString(),
                        lastLogin: null
                    },
                    {
                        id: 'user_3',
                        name: 'Machine Operator',
                        mobile: '9876543212',
                        password: 'operator123',
                        role: 'operator',
                        department: 'Production',
                        createdDate: new Date().toLocaleDateString(),
                        lastLogin: null
                    },
                    {
                        id: 'user_4',
                        name: 'Quality Controller',
                        mobile: '9876543213',
                        password: 'qc123',
                        role: 'qc',
                        department: 'Quality',
                        createdDate: new Date().toLocaleDateString(),
                        lastLogin: null
                    }
                ];
            }
            
            // Initialize machines
            if (!machines.length) {
                for (let i = 1; i <= 17; i++) {
                    machines.push({
                        id: `Machine-${String(i).padStart(2, '0')}`,
                        status: Math.random() > 0.3 ? 'active' : 'idle',
                        efficiency: Math.floor(Math.random() * 30) + 70,
                        lastMaintenance: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toLocaleDateString(),
                        hoursUsed: Math.floor(Math.random() * 2000) + 500,
                        currentOrder: null
                    });
                }
            }
            
            // Initialize yarn inventory
            if (!yarnInventory.length) {
                const yarnTypes = ['Cotton-White', 'Cotton-Black', 'Polyester-Blue', 'Silk-Gold', 'Blend-Gray'];
                yarnTypes.forEach(type => {
                    yarnInventory.push({
                        code: type,
                        quantity: Math.floor(Math.random() * 500) + 100,
                        unit: 'kg',
                        reorderLevel: 50,
                        lastUpdated: new Date().toLocaleDateString()
                    });
                });
            }
        }

        // Google Drive API Configuration (unchanged)
        const GOOGLE_API_KEY = 'YOUR_API_KEY';
        const CLIENT_ID = 'YOUR_CLIENT_ID';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        
        let gapi;
        let googleDriveEnabled = false;
        let driveFileId = null;
        
        // Sync status management (unchanged)
        function updateSyncStatus(status, message) {
            const syncStatus = document.getElementById('syncStatus');
            const syncText = document.getElementById('syncText');
            const syncBtn = document.getElementById('syncBtn');
            const syncBtnText = document.getElementById('syncBtnText');
            
            syncStatus.className = `sync-status sync-${status}`;
            syncText.textContent = message;
            
            switch(status) {
                case 'online':
                    syncBtnText.innerHTML = '‚òÅÔ∏è Drive Connected';
                    syncBtn.className = 'px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm';
                    break;
                case 'offline':
                    syncBtnText.innerHTML = 'üì§ Deploy Info';
                    syncBtn.className = 'px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm';
                    break;
                case 'error':
                    syncBtnText.innerHTML = '‚ö†Ô∏è Drive Error';
                    syncBtn.className = 'px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm';
                    break;
            }
        }

        // Initialize app with enhanced features
        async function initializeGoogleDrive() {
            try {
                updateSyncStatus('offline', 'üíæ Ready - Using Local Storage');
                loadLocalData();
                initializeEnhancedData();
            } catch (error) {
                console.error('Initialization failed:', error);
                updateSyncStatus('error', '‚ùå Storage error');
                loadLocalData();
                initializeEnhancedData();
            }
        }

        // Show Google Drive setup info (unchanged)
        async function toggleGoogleDriveSync() {
            alert(`üöÄ Your Schiffli Production Manager Pro is ready to deploy!

üìã CURRENT STATUS:
‚úÖ Fully functional with local storage
‚úÖ Advanced analytics and reporting
‚úÖ Production management features
‚úÖ Workflow automation
‚úÖ Business intelligence

‚òÅÔ∏è GOOGLE DRIVE SYNC (Optional):
Want multi-device sync? I can help you set up Google Drive integration later.

üì§ DEPLOYMENT READY:
Your enhanced app is optimized for GitHub Pages deployment right now!

Click OK to continue using local storage.`);
        }

        // Enhanced data loading and saving
        function loadLocalData() {
            orders = JSON.parse(localStorage.getItem('schiffliOrders')) || [];
            dailyCounter = JSON.parse(localStorage.getItem('dailyCounter')) || {};
            machines = JSON.parse(localStorage.getItem('machines')) || [];
            yarnInventory = JSON.parse(localStorage.getItem('yarnInventory')) || [];
            maintenanceSchedule = JSON.parse(localStorage.getItem('maintenanceSchedule')) || [];
            productionBatches = JSON.parse(localStorage.getItem('productionBatches')) || [];
            users = JSON.parse(localStorage.getItem('schiffliUsers')) || [];
            currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
        }

        function saveLocalData() {
            localStorage.setItem('schiffliOrders', JSON.stringify(orders));
            localStorage.setItem('dailyCounter', JSON.stringify(dailyCounter));
            localStorage.setItem('machines', JSON.stringify(machines));
            localStorage.setItem('yarnInventory', JSON.stringify(yarnInventory));
            localStorage.setItem('maintenanceSchedule', JSON.stringify(maintenanceSchedule));
            localStorage.setItem('productionBatches', JSON.stringify(productionBatches));
            localStorage.setItem('schiffliUsers', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
        }
        
        // Authentication functions
        function authenticateUser(mobile, password) {
            const user = users.find(u => u.mobile === mobile && u.password === password);
            if (user) {
                currentUser = { ...user };
                currentUser.lastLogin = new Date().toLocaleString();
                
                // Update user's last login
                const userIndex = users.findIndex(u => u.id === user.id);
                if (userIndex !== -1) {
                    users[userIndex].lastLogin = currentUser.lastLogin;
                }
                
                saveLocalData();
                return true;
            }
            return false;
        }
        
        function checkPermission(permission) {
            if (!currentUser) return false;
            const role = userRoles[currentUser.role];
            return role && (role.permissions.includes('all') || role.permissions.includes(permission));
        }
        
        function canAccessSection(section) {
            if (!currentUser) return false;
            const role = userRoles[currentUser.role];
            return role && role.sections.includes(section);
        }
        
        function updateUserInterface() {
            if (!currentUser) return;
            
            // Update user display
            document.getElementById('userDisplayName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = userRoles[currentUser.role].name;
            document.getElementById('userInitials').textContent = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
            document.getElementById('menuUserName').textContent = currentUser.name;
            document.getElementById('menuUserMobile').textContent = currentUser.mobile;
            
            // Show/hide navigation buttons based on permissions
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => {
                const section = btn.id.replace('Btn', '');
                if (!canAccessSection(section)) {
                    btn.style.display = 'none';
                } else {
                    btn.style.display = 'inline-block';
                }
            });
            
            // Show user management button for admins
            if (currentUser.role === 'admin') {
                document.getElementById('userManagementBtn').classList.remove('hidden');
            }
        }
        
        window.logout = function() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('loginModal').classList.add('flex');
            
            // Hide all sections
            const sections = ['dashboard', 'analytics', 'production', 'workflow', 'orders', 'newOrder', 'userManagement', 'userProfile'];
            sections.forEach(s => {
                const element = document.getElementById(s + 'Section');
                if (element) {
                    element.classList.add('hidden');
                }
            });
            
            // Reset form
            document.getElementById('loginForm').reset();
        }

        async function saveData() {
            saveLocalData();
            if (googleDriveEnabled) {
                await syncToGoogleDrive();
            }
        }

        // Login and user management functions
        // Make functions globally accessible
        window.showDemoCredentials = function() {
            document.getElementById('demoCredentialsModal').classList.remove('hidden');
            document.getElementById('demoCredentialsModal').classList.add('flex');
        }
        
        window.closeDemoCredentials = function() {
            document.getElementById('demoCredentialsModal').classList.add('hidden');
            document.getElementById('demoCredentialsModal').classList.remove('flex');
        }
        
        window.fillDemoCredentials = function(type) {
            const credentials = {
                admin: { mobile: '9876543210', password: 'admin123' },
                manager: { mobile: '9876543211', password: 'manager123' },
                operator: { mobile: '9876543212', password: 'operator123' },
                qc: { mobile: '9876543213', password: 'qc123' }
            };
            
            if (credentials[type]) {
                document.getElementById('mobileNumber').value = credentials[type].mobile;
                document.getElementById('password').value = credentials[type].password;
            }
            
            closeDemoCredentials();
        }
        
        window.toggleUserMenu = function() {
            const menu = document.getElementById('userMenu');
            menu.classList.toggle('hidden');
        }
        
        window.showUserProfile = function() {
            if (!currentUser) return;
            
            // Populate profile form
            document.getElementById('profileName').value = currentUser.name;
            document.getElementById('profileMobile').value = currentUser.mobile;
            document.getElementById('profileRole').value = userRoles[currentUser.role].name;
            document.getElementById('profileDepartment').value = currentUser.department || '';
            
            showSection('userProfile');
            document.getElementById('userMenu').classList.add('hidden');
        }
        
        window.showUserManagement = function() {
            if (!checkPermission('all')) {
                alert('Access denied. Admin privileges required.');
                return;
            }
            
            showSection('userManagement');
            updateUsersList();
            document.getElementById('userMenu').classList.add('hidden');
        }
        
        function updateUsersList() {
            const usersList = document.getElementById('usersList');
            
            if (users.length === 0) {
                usersList.innerHTML = '<p class="text-gray-500 text-center py-8">No users found</p>';
                return;
            }
            
            usersList.innerHTML = users.map(user => `
                <div class="flex justify-between items-center p-4 border-b last:border-b-0 hover:bg-gray-50">
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-medium text-gray-900">${user.name}</h4>
                                <p class="text-sm text-gray-600">${user.mobile} ‚Ä¢ ${userRoles[user.role].name}</p>
                            </div>
                            <span class="inline-block px-2 py-1 text-xs rounded-full ${user.role === 'admin' ? 'bg-red-100 text-red-800' : user.role === 'manager' ? 'bg-blue-100 text-blue-800' : user.role === 'qc' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'}">${userRoles[user.role].name}</span>
                        </div>
                        <div class="text-xs text-gray-600">
                            <span>Department: ${user.department || 'N/A'}</span> ‚Ä¢ 
                            <span>Created: ${user.createdDate}</span>
                            ${user.lastLogin ? ` ‚Ä¢ Last Login: ${user.lastLogin}` : ''}
                        </div>
                    </div>
                    <div class="ml-4 flex gap-2">
                        <button onclick="editUser('${user.id}')" class="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">Edit</button>
                        ${user.id !== currentUser.id ? `<button onclick="deleteUser('${user.id}')" class="px-3 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700">Delete</button>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function showAddUserModal() {
            document.getElementById('addUserModal').classList.remove('hidden');
            document.getElementById('addUserModal').classList.add('flex');
        }
        
        function closeAddUserModal() {
            document.getElementById('addUserModal').classList.add('hidden');
            document.getElementById('addUserModal').classList.remove('flex');
            document.getElementById('addUserForm').reset();
        }
        
        async function addUser(userData) {
            // Check if mobile number already exists
            if (users.find(u => u.mobile === userData.mobile)) {
                alert('Mobile number already exists!');
                return false;
            }
            
            const newUser = {
                id: 'user_' + Date.now(),
                name: userData.name,
                mobile: userData.mobile,
                password: userData.password,
                role: userData.role,
                department: userData.department || '',
                createdDate: new Date().toLocaleDateString(),
                lastLogin: null
            };
            
            users.push(newUser);
            await saveData();
            updateUsersList();
            closeAddUserModal();
            
            alert('User added successfully!');
            return true;
        }
        
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            // For demo purposes, just show an alert
            alert(`Edit User: ${user.name}\n\nThis would open an edit modal with the user's current information.`);
        }
        
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            
            const userIndex = users.findIndex(u => u.id === userId);
            if (userIndex !== -1) {
                users.splice(userIndex, 1);
                await saveData();
                updateUsersList();
                alert('User deleted successfully!');
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOM loaded, initializing app...');
            await initializeGoogleDrive();
            
            // Always setup login form first
            setupLoginForm();
            setupProfileForm();
            setupAddUserForm();
            setupMaintenanceForm();
            
            // Check if user is already logged in
            if (currentUser) {
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('loginModal').classList.remove('flex');
                updateUserInterface();
                generateOrderId();
                setupOrderForm();
                updateDashboard();
                updateAnalytics();
                updateProductionManagement();
                updateWorkflowManagement();
                displayOrders();
                showSection('dashboard');
            } else {
                // Show login modal
                document.getElementById('loginModal').classList.remove('hidden');
                document.getElementById('loginModal').classList.add('flex');
            }
            
            console.log('App initialized successfully');
        });

        // Form setup functions
        function setupLoginForm() {
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                // Remove any existing event listeners
                const newForm = loginForm.cloneNode(true);
                loginForm.parentNode.replaceChild(newForm, loginForm);
                
                newForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('Login form submitted');
                    
                    const mobile = document.getElementById('mobileNumber').value;
                    const password = document.getElementById('password').value;
                    const rememberMe = document.getElementById('rememberMe').checked;
                    
                    console.log('Attempting login with:', mobile);
                    
                    if (authenticateUser(mobile, password)) {
                        console.log('Authentication successful');
                        document.getElementById('loginModal').classList.add('hidden');
                        document.getElementById('loginModal').classList.remove('flex');
                        
                        updateUserInterface();
                        generateOrderId();
                        setupOrderForm();
                        updateDashboard();
                        updateAnalytics();
                        updateProductionManagement();
                        updateWorkflowManagement();
                        displayOrders();
                        showSection('dashboard');
                        
                        alert(`Welcome, ${currentUser.name}!`);
                    } else {
                        console.log('Authentication failed');
                        alert('Invalid mobile number or password!');
                    }
                });
            } else {
                console.error('Login form not found');
            }
        }
        
        function setupProfileForm() {
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const name = document.getElementById('profileName').value;
                    const department = document.getElementById('profileDepartment').value;
                    const currentPassword = document.getElementById('currentPassword').value;
                    const newPassword = document.getElementById('newPassword').value;
                    
                    // Update user info
                    if (name !== currentUser.name || department !== currentUser.department) {
                        currentUser.name = name;
                        currentUser.department = department;
                        
                        // Update in users array
                        const userIndex = users.findIndex(u => u.id === currentUser.id);
                        if (userIndex !== -1) {
                            users[userIndex].name = name;
                            users[userIndex].department = department;
                        }
                    }
                    
                    // Update password if provided
                    if (currentPassword && newPassword) {
                        if (currentPassword === currentUser.password) {
                            currentUser.password = newPassword;
                            
                            // Update in users array
                            const userIndex = users.findIndex(u => u.id === currentUser.id);
                            if (userIndex !== -1) {
                                users[userIndex].password = newPassword;
                            }
                        } else {
                            alert('Current password is incorrect!');
                            return;
                        }
                    }
                    
                    await saveData();
                    updateUserInterface();
                    
                    // Clear password fields
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    
                    alert('Profile updated successfully!');
                });
            }
        }
        
        function setupAddUserForm() {
            const addUserForm = document.getElementById('addUserForm');
            if (addUserForm) {
                addUserForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const userData = {
                        name: document.getElementById('newUserName').value,
                        mobile: document.getElementById('newUserMobile').value,
                        role: document.getElementById('newUserRole').value,
                        department: document.getElementById('newUserDepartment').value,
                        password: document.getElementById('newUserPassword').value
                    };
                    
                    await addUser(userData);
                });
            }
        }

        // Enhanced navigation
        window.showSection = function(section) {
            console.log('Showing section:', section); // Debug log
            
            // Check permissions
            if (!canAccessSection(section)) {
                alert('Access denied. You do not have permission to view this section.');
                return;
            }
            
            // Hide all sections
            const sections = ['dashboard', 'analytics', 'production', 'workflow', 'orders', 'newOrder', 'userManagement', 'userProfile'];
            sections.forEach(s => {
                const element = document.getElementById(s + 'Section');
                if (element) {
                    element.classList.add('hidden');
                }
            });
            
            // Reset all navigation button styles
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => {
                btn.className = 'nav-btn px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm';
            });
            
            // Show selected section and highlight button
            const targetSection = document.getElementById(section + 'Section');
            const targetButton = document.getElementById(section + 'Btn');
            
            if (targetSection) {
                targetSection.classList.remove('hidden');
                console.log('Section shown:', section);
            } else {
                console.error('Section not found:', section + 'Section');
            }
            
            if (targetButton) {
                targetButton.className = 'nav-btn px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm';
                console.log('Button highlighted:', section + 'Btn');
            } else {
                console.error('Button not found:', section + 'Btn');
            }
            
            // Update section-specific data
            if (section === 'dashboard') {
                updateDashboard();
            } else if (section === 'analytics') {
                updateAnalytics();
            } else if (section === 'production') {
                updateProductionManagement();
            } else if (section === 'workflow') {
                updateWorkflowManagement();
            } else if (section === 'orders') {
                displayOrders();
            } else if (section === 'userManagement') {
                updateUsersList();
            }
        }

        // Enhanced order creation with workflow
        function generateOrderId() {
            const today = new Date();
            const year = today.getFullYear().toString().slice(-2);
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateKey = year + month + day;
            
            if (!dailyCounter[dateKey]) {
                dailyCounter[dateKey] = 1;
            }
            
            const orderNumber = String(dailyCounter[dateKey]).padStart(2, '0');
            const orderId = dateKey + orderNumber;
            
            document.getElementById('orderId').value = orderId;
        }

        function toggleCustomPlacement() {
            const placement = document.getElementById('embroideryPlacement').value;
            const customDiv = document.getElementById('customPlacementDiv');
            
            if (placement === 'custom') {
                customDiv.classList.remove('hidden');
                document.getElementById('customPlacement').required = true;
            } else {
                customDiv.classList.add('hidden');
                document.getElementById('customPlacement').required = false;
            }
        }

        function previewImage() {
            const file = document.getElementById('designImage').files[0];
            const preview = document.getElementById('imagePreview');
            const img = document.getElementById('previewImg');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                preview.classList.add('hidden');
            }
        }

        // Enhanced order form submission
        function setupOrderForm() {
            const orderForm = document.getElementById('orderForm');
            if (orderForm) {
                orderForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('Form submitted');
                    
                    const imageFile = document.getElementById('designImage').files[0];
                    let imageData = null;
                    
                    if (imageFile) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            imageData = e.target.result;
                            createOrder(imageData);
                        };
                        reader.readAsDataURL(imageFile);
                    } else {
                        createOrder(null);
                    }
                });
            }
        }

        // Enhanced order creation with workflow status
        async function createOrder(imageData, showJobCard = false) {
            const placement = document.getElementById('embroideryPlacement').value;
            const finalPlacement = placement === 'custom' ? 
                document.getElementById('customPlacement').value : placement;
            
            const orderId = document.getElementById('orderId').value;
            
            if (orders.find(o => o.id === orderId)) {
                alert('Order ID already exists! Please refresh to get a new ID.');
                return;
            }

            // Auto-assign machine if not selected
            let assignedMachine = document.getElementById('assignedMachine').value;
            if (!assignedMachine) {
                const availableMachine = machines.find(m => m.status === 'idle');
                assignedMachine = availableMachine ? availableMachine.id : 'Machine-01';
            }

            // Calculate estimated completion date
            const estimatedDays = parseInt(document.getElementById('estimatedDays').value) || 3;
            const completionDate = new Date();
            completionDate.setDate(completionDate.getDate() + estimatedDays);
            
            const order = {
                id: orderId,
                customerName: document.getElementById('customerName').value,
                lotNumber: document.getElementById('lotNumber').value || 'N/A',
                designNumber: document.getElementById('designNumber').value,
                fabricType: document.getElementById('fabricType').value,
                fabricColor: document.getElementById('fabricColor').value,
                yarnCode: document.getElementById('yarnCode').value,
                metersCount: parseInt(document.getElementById('metersCount').value),
                embroideryPlacement: finalPlacement,
                repeatSize: document.getElementById('repeatSize').value,
                assignedMachine: assignedMachine,
                designImage: imageData,
                status: 'pending-approval', // Start with approval workflow
                workflowStage: 'pending-approval',
                priority: document.getElementById('priorityLevel').value || 'normal',
                estimatedCompletion: completionDate.toLocaleDateString(),
                createdDate: new Date().toLocaleDateString(),
                createdTime: new Date().toLocaleTimeString(),
                productionTime: 0,
                qualityChecks: [],
                approvedBy: null,
                approvedDate: null
            };
            
            orders.push(order);
            
            // Update daily counter
            const today = new Date();
            const year = today.getFullYear().toString().slice(-2);
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateKey = year + month + day;
            dailyCounter[dateKey]++;
            
            await saveData();
            
            if (showJobCard) {
                viewJobCard(orderId);
            } else {
                alert('Order created successfully and sent for approval!');
            }
            
            resetForm();
            generateOrderId();
            updateDashboard();
            updateWorkflowManagement();
        }

        function createOrderAndViewJobCard() {
            const form = document.getElementById('orderForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const imageFile = document.getElementById('designImage').files[0];
            let imageData = null;
            
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageData = e.target.result;
                    createOrder(imageData, true);
                };
                reader.readAsDataURL(imageFile);
            } else {
                createOrder(null, true);
            }
        }

        function resetForm() {
            document.getElementById('orderForm').reset();
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('customPlacementDiv').classList.add('hidden');
            generateOrderId();
        }

        // Enhanced dashboard with new metrics
        function updateDashboard() {
            const totalOrders = orders.length;
            const inProduction = orders.filter(o => o.status === 'production').length;
            const completed = orders.filter(o => o.status === 'complete').length;
            const efficiency = calculateOverallEfficiency();
            
            document.getElementById('totalOrders').textContent = totalOrders;
            document.getElementById('inProductionCount').textContent = inProduction;
            document.getElementById('completedCount').textContent = completed;
            document.getElementById('overallEfficiency').textContent = efficiency + '%';
            
            // Today's metrics
            const today = new Date().toLocaleDateString();
            const todayOrders = orders.filter(o => o.createdDate === today).length;
            const todayMeters = orders.filter(o => o.createdDate === today)
                .reduce((sum, o) => sum + o.metersCount, 0);
            const activeMachineCount = machines.filter(m => m.status === 'active').length;
            
            document.getElementById('todayOrders').textContent = todayOrders;
            document.getElementById('todayMeters').textContent = todayMeters + 'm';
            document.getElementById('activeMachines').textContent = activeMachineCount;
            
            // Update alerts
            updateAlerts();
            
            // Display recent orders
            const recentOrders = orders.slice(-5).reverse();
            const recentOrdersList = document.getElementById('recentOrdersList');
            
            if (recentOrders.length === 0) {
                recentOrdersList.innerHTML = '<p class="text-gray-500 text-center py-8">No orders yet</p>';
            } else {
                recentOrdersList.innerHTML = recentOrders.map(order => `
                    <div class="flex justify-between items-center p-4 border-b last:border-b-0">
                        <div>
                            <h4 class="font-medium">${order.id} - ${order.customerName}</h4>
                            <p class="text-sm text-gray-600">${order.designNumber} ‚Ä¢ ${order.metersCount}m</p>
                        </div>
                        <div class="text-right">
                            <span class="inline-block px-2 py-1 text-xs rounded-full ${getStatusClass(order.status)}">${getStatusText(order.status)}</span>
                            <p class="text-xs text-gray-500 mt-1">${order.createdDate}</p>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Calculate overall production efficiency
        function calculateOverallEfficiency() {
            if (machines.length === 0) return 0;
            const totalEfficiency = machines.reduce((sum, m) => sum + m.efficiency, 0);
            return Math.round(totalEfficiency / machines.length);
        }

        // Update alerts and notifications
        function updateAlerts() {
            const alerts = [];
            
            // Check for low yarn inventory
            yarnInventory.forEach(yarn => {
                if (yarn.quantity <= yarn.reorderLevel) {
                    alerts.push(`Low stock: ${yarn.code} (${yarn.quantity}${yarn.unit})`);
                }
            });
            
            // Check for machines needing maintenance
            machines.forEach(machine => {
                if (machine.hoursUsed > 1800) {
                    alerts.push(`${machine.id} needs maintenance (${machine.hoursUsed}h)`);
                }
            });
            
            // Check for overdue orders
            const today = new Date();
            orders.forEach(order => {
                const estimatedDate = new Date(order.estimatedCompletion);
                if (estimatedDate < today && order.status !== 'complete') {
                    alerts.push(`Order ${order.id} is overdue`);
                }
            });
            
            const alertsList = document.getElementById('alertsList');
            if (alerts.length === 0) {
                alertsList.innerHTML = '<p class="text-gray-500 text-sm">No alerts</p>';
            } else {
                alertsList.innerHTML = alerts.slice(0, 3).map(alert => `
                    <div class="flex items-center text-sm text-orange-600">
                        <span class="mr-2">‚ö†Ô∏è</span>
                        <span>${alert}</span>
                    </div>
                `).join('');
            }
        }

        // Analytics section
        function updateAnalytics() {
            const timeframe = parseInt(document.getElementById('analyticsTimeframe')?.value || 30);
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - timeframe);
            
            const recentOrders = orders.filter(o => new Date(o.createdDate) >= cutoffDate);
            
            // Calculate metrics
            const efficiency = calculateOverallEfficiency();
            const avgOrderTime = calculateAverageOrderTime(recentOrders);
            const machineUtilization = calculateMachineUtilization();
            const qualityScore = calculateQualityScore(recentOrders);
            
            // Update analytics display
            document.getElementById('analyticsEfficiency').textContent = efficiency + '%';
            document.getElementById('efficiencyPercent').textContent = efficiency + '%';
            document.getElementById('avgOrderTime').textContent = avgOrderTime + ' days';
            document.getElementById('machineUtilization').textContent = machineUtilization + '%';
            document.getElementById('qualityScore').textContent = qualityScore + '%';
        }

        function calculateAverageOrderTime(orderList) {
            const completedOrders = orderList.filter(o => o.status === 'complete');
            if (completedOrders.length === 0) return 0;
            
            const totalTime = completedOrders.reduce((sum, order) => {
                const created = new Date(order.createdDate);
                const completed = new Date(order.estimatedCompletion);
                const days = Math.ceil((completed - created) / (1000 * 60 * 60 * 24));
                return sum + days;
            }, 0);
            
            return Math.round(totalTime / completedOrders.length * 10) / 10;
        }

        function calculateMachineUtilization() {
            const activeMachines = machines.filter(m => m.status === 'active').length;
            return Math.round((activeMachines / machines.length) * 100);
        }

        function calculateQualityScore(orderList) {
            const qualityOrders = orderList.filter(o => o.qualityChecks && o.qualityChecks.length > 0);
            if (qualityOrders.length === 0) return 95; // Default score
            
            const totalScore = qualityOrders.reduce((sum, order) => {
                const avgScore = order.qualityChecks.reduce((s, check) => s + check.score, 0) / order.qualityChecks.length;
                return sum + avgScore;
            }, 0);
            
            return Math.round(totalScore / qualityOrders.length);
        }

        // Production Management
        function updateProductionManagement() {
            updateMachineStatus();
            updateYarnInventory();
            updateProductionEstimates();
            updateBatchOrderSelection();
            updateActiveBatches();
        }

        function updateMachineStatus() {
            const machineStatusList = document.getElementById('machineStatusList');
            
            machineStatusList.innerHTML = machines.slice(0, 5).map(machine => `
                <div class="flex justify-between items-center p-3 border-b last:border-b-0">
                    <div>
                        <h4 class="font-medium text-sm">${machine.id}</h4>
                        <p class="text-xs text-gray-600">Efficiency: ${machine.efficiency}%</p>
                    </div>
                    <div class="text-right">
                        <span class="inline-block px-2 py-1 text-xs rounded-full ${machine.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">${machine.status}</span>
                        <p class="text-xs text-gray-500">${machine.hoursUsed}h</p>
                    </div>
                </div>
            `).join('');
        }

        function updateYarnInventory() {
            const yarnInventoryList = document.getElementById('yarnInventoryList');
            
            yarnInventoryList.innerHTML = yarnInventory.map(yarn => `
                <div class="flex justify-between items-center p-3 border-b last:border-b-0">
                    <div>
                        <h4 class="font-medium text-sm">${yarn.code}</h4>
                        <p class="text-xs text-gray-600">${yarn.quantity} ${yarn.unit}</p>
                    </div>
                    <div class="text-right">
                        <span class="inline-block px-2 py-1 text-xs rounded-full ${yarn.quantity <= yarn.reorderLevel ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                            ${yarn.quantity <= yarn.reorderLevel ? 'Low' : 'OK'}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function updateProductionEstimates() {
            const productionEstimates = document.getElementById('productionEstimates');
            const pendingOrders = orders.filter(o => o.status === 'pending' || o.status === 'approved');
            const totalMeters = pendingOrders.reduce((sum, o) => sum + o.metersCount, 0);
            const avgProductionRate = 150; // meters per day per machine
            const activeMachines = machines.filter(m => m.status === 'active').length;
            const estimatedDays = Math.ceil(totalMeters / (avgProductionRate * activeMachines));
            
            productionEstimates.innerHTML = `
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Pending Orders:</span>
                        <span class="font-medium">${pendingOrders.length}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Total Meters:</span>
                        <span class="font-medium">${totalMeters}m</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Est. Completion:</span>
                        <span class="font-medium">${estimatedDays} days</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Active Machines:</span>
                        <span class="font-medium">${activeMachines}</span>
                    </div>
                </div>
            `;
        }

        // Batch Processing
        function updateBatchOrderSelection() {
            const batchOrderSelection = document.getElementById('batchOrderSelection');
            const availableOrders = orders.filter(o => o.status === 'approved' || o.status === 'pending');
            
            if (availableOrders.length === 0) {
                batchOrderSelection.innerHTML = '<p class="text-gray-500 text-sm">No orders available for batching</p>';
                return;
            }
            
            batchOrderSelection.innerHTML = availableOrders.map(order => `
                <div class="flex items-center p-2 hover:bg-gray-50">
                    <input type="checkbox" id="batch_${order.id}" value="${order.id}" class="mr-3">
                    <label for="batch_${order.id}" class="flex-1 text-sm cursor-pointer">
                        ${order.id} - ${order.customerName} (${order.metersCount}m)
                    </label>
                </div>
            `).join('');
        }

        function createBatch() {
            const batchName = document.getElementById('batchName').value;
            if (!batchName) {
                alert('Please enter a batch name');
                return;
            }
            
            const selectedOrders = Array.from(document.querySelectorAll('#batchOrderSelection input:checked'))
                .map(cb => cb.value);
            
            if (selectedOrders.length === 0) {
                alert('Please select at least one order');
                return;
            }
            
            const batch = {
                id: 'BATCH-' + Date.now(),
                name: batchName,
                orders: selectedOrders,
                status: 'active',
                createdDate: new Date().toLocaleDateString(),
                estimatedCompletion: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toLocaleDateString()
            };
            
            productionBatches.push(batch);
            
            // Update order statuses
            selectedOrders.forEach(orderId => {
                const order = orders.find(o => o.id === orderId);
                if (order) {
                    order.batchId = batch.id;
                    order.status = 'production';
                }
            });
            
            saveData();
            document.getElementById('batchName').value = '';
            document.querySelectorAll('#batchOrderSelection input:checked').forEach(cb => cb.checked = false);
            updateBatchOrderSelection();
            updateActiveBatches();
            updateDashboard();
            
            alert('Batch created successfully!');
        }

        function updateActiveBatches() {
            const activeBatchesList = document.getElementById('activeBatchesList');
            const activeBatches = productionBatches.filter(b => b.status === 'active');
            
            if (activeBatches.length === 0) {
                activeBatchesList.innerHTML = '<p class="text-gray-500 text-sm">No active batches</p>';
                return;
            }
            
            activeBatchesList.innerHTML = activeBatches.map(batch => `
                <div class="p-3 border rounded-lg">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-medium text-sm">${batch.name}</h4>
                        <span class="text-xs text-blue-600">${batch.orders.length} orders</span>
                    </div>
                    <p class="text-xs text-gray-600">Created: ${batch.createdDate}</p>
                    <p class="text-xs text-gray-600">Est. Complete: ${batch.estimatedCompletion}</p>
                    <button onclick="completeBatch('${batch.id}')" class="mt-2 px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">Complete</button>
                </div>
            `).join('');
        }

        function completeBatch(batchId) {
            const batch = productionBatches.find(b => b.id === batchId);
            if (batch) {
                batch.status = 'complete';
                batch.completedDate = new Date().toLocaleDateString();
                
                // Update order statuses
                batch.orders.forEach(orderId => {
                    const order = orders.find(o => o.id === orderId);
                    if (order) {
                        order.status = 'quality-check';
                    }
                });
                
                saveData();
                updateActiveBatches();
                updateWorkflowManagement();
                updateDashboard();
                
                alert('Batch completed! Orders moved to quality check.');
            }
        }

        // Workflow Management
        function updateWorkflowManagement() {
            const pendingApproval = orders.filter(o => o.workflowStage === 'pending-approval').length;
            const approved = orders.filter(o => o.workflowStage === 'approved').length;
            const qualityCheck = orders.filter(o => o.workflowStage === 'quality-check').length;
            const readyDelivery = orders.filter(o => o.status === 'complete').length;
            
            document.getElementById('pendingApprovalCount').textContent = pendingApproval;
            document.getElementById('approvedCount').textContent = approved;
            document.getElementById('qualityCheckCount').textContent = qualityCheck;
            document.getElementById('readyDeliveryCount').textContent = readyDelivery;
            
            updateWorkflowOrdersList();
        }

        function updateWorkflowOrdersList() {
            const workflowOrdersList = document.getElementById('workflowOrdersList');
            const filter = document.getElementById('workflowFilter')?.value || 'all';
            
            let filteredOrders = orders;
            if (filter !== 'all') {
                filteredOrders = orders.filter(order => order.workflowStage === filter || order.status === filter);
            }
            
            if (filteredOrders.length === 0) {
                workflowOrdersList.innerHTML = '<p class="text-gray-500 text-center py-8">No orders found</p>';
                return;
            }
            
            workflowOrdersList.innerHTML = filteredOrders.map(order => `
                <div class="flex justify-between items-center p-4 border-b last:border-b-0 hover:bg-gray-50">
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-medium text-gray-900">${order.id} - ${order.customerName}</h4>
                                <p class="text-sm text-gray-600">${order.designNumber} ‚Ä¢ ${order.metersCount}m</p>
                            </div>
                            <span class="inline-block px-2 py-1 text-xs rounded-full ${getWorkflowStatusClass(order.workflowStage || order.status)}">${getWorkflowStatusText(order.workflowStage || order.status)}</span>
                        </div>
                        <div class="text-xs text-gray-600">
                            <span>Priority: ${order.priority || 'normal'}</span> ‚Ä¢ 
                            <span>Created: ${order.createdDate}</span>
                        </div>
                    </div>
                    <div class="ml-4 flex gap-2">
                        ${getWorkflowActions(order)}
                    </div>
                </div>
            `).join('');
        }

        function getWorkflowActions(order) {
            const stage = order.workflowStage || order.status;
            
            switch(stage) {
                case 'pending-approval':
                    return `
                        <button onclick="approveOrder('${order.id}')" class="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">Approve</button>
                        <button onclick="rejectOrder('${order.id}')" class="px-3 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700">Reject</button>
                    `;
                case 'approved':
                    return `
                        <button onclick="startProduction('${order.id}')" class="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">Start Production</button>
                    `;
                case 'production':
                    return `
                        <button onclick="moveToQualityCheck('${order.id}')" class="px-3 py-1 bg-orange-600 text-white rounded text-xs hover:bg-orange-700">Quality Check</button>
                    `;
                case 'quality-check':
                    return `
                        <button onclick="passQualityCheck('${order.id}')" class="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">Pass QC</button>
                        <button onclick="failQualityCheck('${order.id}')" class="px-3 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700">Fail QC</button>
                    `;
                default:
                    return `<button onclick="viewJobCard('${order.id}')" class="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">View</button>`;
            }
        }

        function getWorkflowStatusClass(status) {
            switch(status) {
                case 'pending-approval': return 'bg-yellow-100 text-yellow-800';
                case 'approved': return 'bg-blue-100 text-blue-800';
                case 'production': return 'bg-purple-100 text-purple-800';
                case 'quality-check': return 'bg-orange-100 text-orange-800';
                case 'complete': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getWorkflowStatusText(status) {
            switch(status) {
                case 'pending-approval': return 'Pending Approval';
                case 'approved': return 'Approved';
                case 'production': return 'In Production';
                case 'quality-check': return 'Quality Check';
                case 'complete': return 'Complete';
                default: return 'Unknown';
            }
        }

        // Workflow actions
        async function approveOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                order.workflowStage = 'approved';
                order.status = 'approved';
                order.approvedBy = 'Manager'; // In real app, this would be current user
                order.approvedDate = new Date().toLocaleDateString();
                await saveData();
                updateWorkflowManagement();
                updateDashboard();
            }
        }

        async function rejectOrder(orderId) {
            const reason = prompt('Reason for rejection:');
            if (reason) {
                const order = orders.find(o => o.id === orderId);
                if (order) {
                    order.workflowStage = 'rejected';
                    order.status = 'rejected';
                    order.rejectionReason = reason;
                    await saveData();
                    updateWorkflowManagement();
                    updateDashboard();
                }
            }
        }

        async function startProduction(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                order.workflowStage = 'production';
                order.status = 'production';
                order.productionStartDate = new Date().toLocaleDateString();
                
                // Update assigned machine status
                const machine = machines.find(m => m.id === order.assignedMachine);
                if (machine) {
                    machine.status = 'active';
                    machine.currentOrder = orderId;
                }
                
                await saveData();
                updateWorkflowManagement();
                updateProductionManagement();
                updateDashboard();
            }
        }

        async function moveToQualityCheck(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                order.workflowStage = 'quality-check';
                order.status = 'quality-check';
                order.productionEndDate = new Date().toLocaleDateString();
                
                // Free up machine
                const machine = machines.find(m => m.currentOrder === orderId);
                if (machine) {
                    machine.status = 'idle';
                    machine.currentOrder = null;
                }
                
                await saveData();
                updateWorkflowManagement();
                updateProductionManagement();
                updateDashboard();
            }
        }

        async function passQualityCheck(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                order.workflowStage = 'complete';
                order.status = 'complete';
                order.qualityCheckDate = new Date().toLocaleDateString();
                order.qualityChecks = order.qualityChecks || [];
                order.qualityChecks.push({
                    date: new Date().toLocaleDateString(),
                    result: 'pass',
                    score: 95,
                    inspector: 'QC Team'
                });
                
                await saveData();
                updateWorkflowManagement();
                updateDashboard();
            }
        }

        async function failQualityCheck(orderId) {
            const reason = prompt('Quality check failure reason:');
            if (reason) {
                const order = orders.find(o => o.id === orderId);
                if (order) {
                    order.workflowStage = 'production'; // Send back to production
                    order.status = 'production';
                    order.qualityChecks = order.qualityChecks || [];
                    order.qualityChecks.push({
                        date: new Date().toLocaleDateString(),
                        result: 'fail',
                        reason: reason,
                        score: 60,
                        inspector: 'QC Team'
                    });
                    
                    await saveData();
                    updateWorkflowManagement();
                    updateDashboard();
                }
            }
        }

        function filterWorkflowOrders() {
            updateWorkflowOrdersList();
        }

        // Maintenance Management
        function scheduleMaintenance() {
            document.getElementById('maintenanceModal').classList.remove('hidden');
            document.getElementById('maintenanceModal').classList.add('flex');
        }

        function closeMaintenanceModal() {
            document.getElementById('maintenanceModal').classList.add('hidden');
            document.getElementById('maintenanceModal').classList.remove('flex');
        }

        function setupMaintenanceForm() {
            const maintenanceForm = document.getElementById('maintenanceForm');
            if (maintenanceForm) {
                maintenanceForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const maintenance = {
                        id: 'MAINT-' + Date.now(),
                        machine: document.getElementById('maintenanceMachine').value,
                        date: document.getElementById('maintenanceDate').value,
                        type: document.getElementById('maintenanceType').value,
                        notes: document.getElementById('maintenanceNotes').value,
                        status: 'scheduled',
                        createdDate: new Date().toLocaleDateString()
                    };
                    
                    maintenanceSchedule.push(maintenance);
                    await saveData();
                    
                    closeMaintenanceModal();
                    document.getElementById('maintenanceForm').reset();
                    updateProductionManagement();
                    
                    alert('Maintenance scheduled successfully!');
                });
            }
        }

        function updateYarnInventory() {
            // This would open a modal to update yarn quantities
            alert('Yarn inventory update feature - would open detailed inventory management modal');
        }

        // Enhanced order display and filtering
        function displayOrders() {
            const ordersList = document.getElementById('ordersList');
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filteredOrders = orders;
            if (statusFilter !== 'all') {
                filteredOrders = orders.filter(order => order.status === statusFilter || order.workflowStage === statusFilter);
            }
            
            if (filteredOrders.length === 0) {
                ordersList.innerHTML = '<p class="text-gray-500 text-center py-8">No orders found</p>';
                return;
            }
            
            ordersList.innerHTML = filteredOrders.map(order => `
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">${order.id}</h3>
                            <p class="text-gray-600">${order.customerName}</p>
                            ${order.priority && order.priority !== 'normal' ? `<span class="inline-block px-2 py-1 text-xs rounded-full bg-red-100 text-red-800 mt-1">${order.priority.toUpperCase()}</span>` : ''}
                        </div>
                        <div class="flex gap-2">
                            <span class="inline-block px-3 py-1 text-sm rounded-full ${getStatusClass(order.status)}">${getStatusText(order.status)}</span>
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <p class="text-sm text-gray-600">Design: <span class="font-medium">${order.designNumber}</span></p>
                            <p class="text-sm text-gray-600">Fabric: <span class="font-medium">${order.fabricType} (${order.fabricColor})</span></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Meters: <span class="font-medium">${order.metersCount}m</span></p>
                            <p class="text-sm text-gray-600">Placement: <span class="font-medium">${order.embroideryPlacement}</span></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Machine: <span class="font-medium">${order.assignedMachine}</span></p>
                            <p class="text-sm text-gray-600">Est. Complete: <span class="font-medium">${order.estimatedCompletion}</span></p>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="viewJobCard('${order.id}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">View Job Card</button>
                        <select onchange="updateOrderStatus('${order.id}', this.value)" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="pending-approval" ${order.status === 'pending-approval' ? 'selected' : ''}>Pending Approval</option>
                            <option value="approved" ${order.status === 'approved' ? 'selected' : ''}>Approved</option>
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="production" ${order.status === 'production' ? 'selected' : ''}>In Production</option>
                            <option value="quality-check" ${order.status === 'quality-check' ? 'selected' : ''}>Quality Check</option>
                            <option value="complete" ${order.status === 'complete' ? 'selected' : ''}>Complete</option>
                        </select>
                    </div>
                </div>
            `).join('');
        }

        function filterOrders() {
            displayOrders();
        }

        async function updateOrderStatus(orderId, newStatus) {
            const orderIndex = orders.findIndex(order => order.id === orderId);
            if (orderIndex !== -1) {
                orders[orderIndex].status = newStatus;
                orders[orderIndex].workflowStage = newStatus;
                await saveData();
                updateDashboard();
                updateWorkflowManagement();
                displayOrders();
            }
        }

        function getStatusClass(status) {
            switch(status) {
                case 'pending-approval': return 'bg-yellow-100 text-yellow-800';
                case 'approved': return 'bg-blue-100 text-blue-800';
                case 'pending': return 'bg-yellow-100 text-yellow-800';
                case 'production': return 'bg-purple-100 text-purple-800';
                case 'quality-check': return 'bg-orange-100 text-orange-800';
                case 'complete': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'pending-approval': return 'Pending Approval';
                case 'approved': return 'Approved';
                case 'pending': return 'Pending';
                case 'production': return 'In Production';
                case 'quality-check': return 'Quality Check';
                case 'complete': return 'Complete';
                default: return 'Unknown';
            }
        }

        // Report Generation Functions
        function generateProductionReport() {
            alert('Generating comprehensive production report...\n\nThis would create a detailed PDF report with:\n‚Ä¢ Production statistics\n‚Ä¢ Machine utilization\n‚Ä¢ Order completion rates\n‚Ä¢ Quality metrics\n‚Ä¢ Efficiency analysis');
        }

        function generateWeeklyReport() {
            alert('Generating weekly production summary...\n\nReport includes:\n‚Ä¢ Orders completed this week\n‚Ä¢ Machine performance\n‚Ä¢ Quality scores\n‚Ä¢ Upcoming deadlines');
        }

        function generateMonthlyReport() {
            alert('Generating monthly analysis report...\n\nComprehensive monthly breakdown:\n‚Ä¢ Production trends\n‚Ä¢ Customer analysis\n‚Ä¢ Efficiency improvements\n‚Ä¢ Resource utilization');
        }

        function generateCustomerReport() {
            const customer = prompt('Enter customer name for order history:');
            if (customer) {
                alert(`Generating order history report for: ${customer}\n\nReport includes:\n‚Ä¢ All orders from this customer\n‚Ä¢ Order patterns and preferences\n‚Ä¢ Quality history\n‚Ä¢ Delivery performance`);
            }
        }

        function exportAnalyticsReport() {
            alert('Exporting analytics report...\n\nThis would generate a comprehensive Excel/PDF report with:\n‚Ä¢ All analytics data\n‚Ä¢ Charts and graphs\n‚Ä¢ Trend analysis\n‚Ä¢ Recommendations');
        }

        // Enhanced Job Card and PDF functions (keeping existing functionality)
        function viewJobCard(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            const jobCardContent = `
                <div class="w-full max-w-none bg-white" style="width: 210mm; min-height: 297mm; padding: 20mm; box-sizing: border-box; font-size: 12px; line-height: 1.4;">
                    <!-- Header -->
                    <div class="text-center mb-6 border-b-2 border-gray-800 pb-4">
                        <h1 class="text-2xl font-bold text-gray-900 mb-1">SCHIFFLI EMBROIDERY PRO</h1>
                        <h2 class="text-lg font-semibold text-gray-700">PRODUCTION JOB CARD</h2>
                        <p class="text-sm text-gray-600 mt-2">Order ID: <span class="font-bold text-lg">${order.id}</span></p>
                        ${order.priority && order.priority !== 'normal' ? `<p class="text-sm font-bold text-red-600">PRIORITY: ${order.priority.toUpperCase()}</p>` : ''}
                    </div>
                    
                    <!-- Main Content Grid -->
                    <div class="grid grid-cols-2 gap-6 mb-6" style="height: auto;">
                        <!-- Left Column - Order Details -->
                        <div class="space-y-4">
                            <div>
                                <h3 class="text-sm font-bold mb-2 border-b border-gray-400 pb-1">ORDER INFORMATION</h3>
                                <div class="space-y-1 text-xs">
                                    <p><span class="font-medium">Customer:</span> ${order.customerName}</p>
                                    <p><span class="font-medium">Lot Number:</span> ${order.lotNumber}</p>
                                    <p><span class="font-medium">Design Number:</span> ${order.designNumber}</p>
                                    <p><span class="font-medium">Date Created:</span> ${order.createdDate}</p>
                                    <p><span class="font-medium">Est. Completion:</span> ${order.estimatedCompletion}</p>
                                    <p><span class="font-medium">Status:</span> <span class="font-bold">${getStatusText(order.status).toUpperCase()}</span></p>
                                    ${order.batchId ? `<p><span class="font-medium">Batch ID:</span> ${order.batchId}</p>` : ''}
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="text-sm font-bold mb-2 border-b border-gray-400 pb-1">FABRIC DETAILS</h3>
                                <div class="space-y-1 text-xs">
                                    <p><span class="font-medium">Fabric Type:</span> ${order.fabricType}</p>
                                    <p><span class="font-medium">Fabric Color:</span> ${order.fabricColor}</p>
                                    <p><span class="font-medium">Yarn Code:</span> ${order.yarnCode}</p>
                                    <p><span class="font-medium">Meters to Produce:</span> <span class="font-bold text-base">${order.metersCount}m</span></p>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="text-sm font-bold mb-2 border-b border-gray-400 pb-1">EMBROIDERY DETAILS</h3>
                                <div class="space-y-1 text-xs">
                                    <p><span class="font-medium">Placement:</span> ${order.embroideryPlacement}</p>
                                    <p><span class="font-medium">Repeat Size:</span> ${order.repeatSize}</p>
                                    <p><span class="font-medium">Assigned Machine:</span> <span class="font-bold">${order.assignedMachine}</span></p>
                                </div>
                            </div>

                            ${order.approvedBy ? `
                            <div>
                                <h3 class="text-sm font-bold mb-2 border-b border-gray-400 pb-1">APPROVAL INFO</h3>
                                <div class="space-y-1 text-xs">
                                    <p><span class="font-medium">Approved By:</span> ${order.approvedBy}</p>
                                    <p><span class="font-medium">Approval Date:</span> ${order.approvedDate}</p>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <!-- Right Column - Design Image -->
                        <div class="flex flex-col">
                            <h3 class="text-sm font-bold mb-2 border-b border-gray-400 pb-1">DESIGN REFERENCE</h3>
                            <div class="flex-1 border-2 border-gray-400 bg-gray-50 flex items-center justify-center" style="width: 148mm; height: 210mm; max-width: 100%;">
                                ${order.designImage ? `
                                    <img src="${order.designImage}" alt="Design" class="max-w-full max-h-full object-contain">
                                ` : `
                                    <div class="text-center text-gray-500">
                                        <p class="text-lg mb-2">üìê</p>
                                        <p class="text-xs">No Design Image</p>
                                        <p class="text-xs">Uploaded</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Production Notes -->
                    <div class="mb-6">
                        <h3 class="text-sm font-bold mb-2 border-b border-gray-400 pb-1">PRODUCTION NOTES & QUALITY CHECKS</h3>
                        <div class="border border-gray-400 bg-gray-50 p-3" style="min-height: 60mm;">
                            <div class="grid grid-cols-2 gap-4 text-xs">
                                <div>
                                    <p class="font-medium mb-1">Pre-Production Checklist:</p>
                                    <div class="space-y-1">
                                        <p>‚òê Design file verified</p>
                                        <p>‚òê Fabric quality checked</p>
                                        <p>‚òê Yarn availability confirmed</p>
                                        <p>‚òê Machine setup completed</p>
                                    </div>
                                </div>
                                <div>
                                    <p class="font-medium mb-1">Quality Control:</p>
                                    <div class="space-y-1">
                                        <p>‚òê First piece approval</p>
                                        <p>‚òê Color matching verified</p>
                                        <p>‚òê Stitch quality checked</p>
                                        <p>‚òê Final inspection passed</p>
                                    </div>
                                </div>
                            </div>
                            ${order.qualityChecks && order.qualityChecks.length > 0 ? `
                            <div class="mt-3 border-t border-gray-300 pt-2">
                                <p class="text-xs font-medium">Quality Check History:</p>
                                ${order.qualityChecks.map(check => `
                                    <p class="text-xs">${check.date}: ${check.result} (Score: ${check.score}%) - ${check.inspector}</p>
                                `).join('')}
                            </div>
                            ` : ''}
                            <div class="mt-3 border-t border-gray-300 pt-2">
                                <p class="text-xs font-medium">Additional Notes:</p>
                                <div class="mt-1" style="min-height: 20mm; border-bottom: 1px solid #ccc;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Signatures -->
                    <div class="grid grid-cols-3 gap-6 border-t-2 border-gray-800 pt-4">
                        <div class="text-center">
                            <div class="border-b border-gray-600 mb-2" style="height: 15mm;"></div>
                            <p class="text-xs font-bold">Production Manager</p>
                            <p class="text-xs text-gray-600">Date: ___________</p>
                        </div>
                        <div class="text-center">
                            <div class="border-b border-gray-600 mb-2" style="height: 15mm;"></div>
                            <p class="text-xs font-bold">Quality Control</p>
                            <p class="text-xs text-gray-600">Date: ___________</p>
                        </div>
                        <div class="text-center">
                            <div class="border-b border-gray-600 mb-2" style="height: 15mm;"></div>
                            <p class="text-xs font-bold">Supervisor</p>
                            <p class="text-xs text-gray-600">Date: ___________</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('jobCardContent').innerHTML = jobCardContent;
            document.getElementById('jobCardModal').classList.remove('hidden');
            document.getElementById('jobCardModal').classList.add('flex');
        }

        function closeJobCard() {
            document.getElementById('jobCardModal').classList.add('hidden');
            document.getElementById('jobCardModal').classList.remove('flex');
        }

        function generateJobCardPDF(order) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Set font
            doc.setFont('helvetica');
            
            // Header
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('SCHIFFLI EMBROIDERY PRO', 105, 20, { align: 'center' });
            
            doc.setFontSize(14);
            doc.text('PRODUCTION JOB CARD', 105, 30, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`Order ID: ${order.id}`, 105, 40, { align: 'center' });
            
            if (order.priority && order.priority !== 'normal') {
                doc.setFontSize(10);
                doc.setTextColor(255, 0, 0);
                doc.text(`PRIORITY: ${order.priority.toUpperCase()}`, 105, 47, { align: 'center' });
                doc.setTextColor(0, 0, 0);
            }
            
            // Draw line
            doc.line(20, 50, 190, 50);
            
            // Order Information
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('ORDER INFORMATION', 20, 60);
            doc.line(20, 62, 90, 62);
            
            doc.setFont('helvetica', 'normal');
            let yPos = 70;
            doc.text(`Customer: ${order.customerName}`, 20, yPos);
            doc.text(`Lot Number: ${order.lotNumber}`, 20, yPos += 7);
            doc.text(`Design Number: ${order.designNumber}`, 20, yPos += 7);
            doc.text(`Date Created: ${order.createdDate}`, 20, yPos += 7);
            doc.text(`Est. Completion: ${order.estimatedCompletion}`, 20, yPos += 7);
            doc.text(`Status: ${getStatusText(order.status).toUpperCase()}`, 20, yPos += 7);
            
            if (order.batchId) {
                doc.text(`Batch ID: ${order.batchId}`, 20, yPos += 7);
            }
            
            // Fabric Details
            yPos += 15;
            doc.setFont('helvetica', 'bold');
            doc.text('FABRIC DETAILS', 20, yPos);
            doc.line(20, yPos + 2, 90, yPos + 2);
            
            doc.setFont('helvetica', 'normal');
            doc.text(`Fabric Type: ${order.fabricType}`, 20, yPos += 10);
            doc.text(`Fabric Color: ${order.fabricColor}`, 20, yPos += 7);
            doc.text(`Yarn Code: ${order.yarnCode}`, 20, yPos += 7);
            doc.text(`Meters to Produce: ${order.metersCount}m`, 20, yPos += 7);
            
            // Embroidery Details
            yPos += 15;
            doc.setFont('helvetica', 'bold');
            doc.text('EMBROIDERY DETAILS', 20, yPos);
            doc.line(20, yPos + 2, 90, yPos + 2);
            
            doc.setFont('helvetica', 'normal');
            doc.text(`Placement: ${order.embroideryPlacement}`, 20, yPos += 10);
            doc.text(`Repeat Size: ${order.repeatSize}`, 20, yPos += 7);
            doc.text(`Assigned Machine: ${order.assignedMachine}`, 20, yPos += 7);
            
            // Approval Info
            if (order.approvedBy) {
                yPos += 15;
                doc.setFont('helvetica', 'bold');
                doc.text('APPROVAL INFO', 20, yPos);
                doc.line(20, yPos + 2, 90, yPos + 2);
                
                doc.setFont('helvetica', 'normal');
                doc.text(`Approved By: ${order.approvedBy}`, 20, yPos += 10);
                doc.text(`Approval Date: ${order.approvedDate}`, 20, yPos += 7);
            }
            
            // Design Reference Area
            doc.setFont('helvetica', 'bold');
            doc.text('DESIGN REFERENCE', 110, 60);
            doc.line(110, 62, 190, 62);
            
            // Draw design area box
            doc.rect(110, 65, 75, 100);
            
            // Add design image if available
            if (order.designImage) {
                try {
                    doc.addImage(order.designImage, 'JPEG', 115, 70, 65, 90);
                } catch (e) {
                    doc.setFont('helvetica', 'normal');
                    doc.text('Design Image', 147, 110, { align: 'center' });
                    doc.text('Available', 147, 120, { align: 'center' });
                }
            } else {
                doc.setFont('helvetica', 'normal');
                doc.text('No Design Image', 147, 110, { align: 'center' });
                doc.text('Uploaded', 147, 120, { align: 'center' });
            }
            
            // Production Notes
            doc.setFont('helvetica', 'bold');
            doc.text('PRODUCTION NOTES & QUALITY CHECKS', 20, 190);
            doc.line(20, 192, 190, 192);
            
            // Draw notes box
            doc.rect(20, 195, 170, 50);
            
            // Pre-Production Checklist
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('Pre-Production Checklist:', 25, 205);
            
            doc.setFont('helvetica', 'normal');
            doc.text('‚òê Design file verified', 25, 212);
            doc.text('‚òê Fabric quality checked', 25, 219);
            doc.text('‚òê Yarn availability confirmed', 25, 226);
            doc.text('‚òê Machine setup completed', 25, 233);
            
            // Quality Control
            doc.setFont('helvetica', 'bold');
            doc.text('Quality Control:', 105, 205);
            
            doc.setFont('helvetica', 'normal');
            doc.text('‚òê First piece approval', 105, 212);
            doc.text('‚òê Color matching verified', 105, 219);
            doc.text('‚òê Stitch quality checked', 105, 226);
            doc.text('‚òê Final inspection passed', 105, 233);
            
            // Quality Check History
            if (order.qualityChecks && order.qualityChecks.length > 0) {
                doc.setFont('helvetica', 'bold');
                doc.text('Quality Check History:', 25, 240);
                doc.setFont('helvetica', 'normal');
                order.qualityChecks.forEach((check, index) => {
                    if (240 + (index + 1) * 5 < 245) {
                        doc.text(`${check.date}: ${check.result} (${check.score}%)`, 25, 240 + (index + 1) * 5);
                    }
                });
            }
            
            // Signature lines
            doc.line(20, 255, 190, 255);
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('Production Manager', 35, 270, { align: 'center' });
            doc.text('Quality Control', 105, 270, { align: 'center' });
            doc.text('Supervisor', 175, 270, { align: 'center' });
            
            // Signature lines
            doc.line(20, 265, 50, 265);
            doc.line(90, 265, 120, 265);
            doc.line(160, 265, 190, 265);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.text('Date: ___________', 35, 275, { align: 'center' });
            doc.text('Date: ___________', 105, 275, { align: 'center' });
            doc.text('Date: ___________', 175, 275, { align: 'center' });
            
            return doc;
        }

        function saveJobCardAsPDF() {
            const order = orders.find(o => document.getElementById('jobCardContent').innerHTML.includes(o.id));
            if (!order) return;
            
            try {
                const doc = generateJobCardPDF(order);
                doc.save(`job-card-${order.id}.pdf`);
                
                // Show success message
                const originalText = event.target.textContent;
                event.target.textContent = 'Saved!';
                event.target.classList.remove('bg-green-600', 'hover:bg-green-700');
                event.target.classList.add('bg-green-500');
                
                setTimeout(() => {
                    event.target.textContent = originalText;
                    event.target.classList.remove('bg-green-500');
                    event.target.classList.add('bg-green-600', 'hover:bg-green-700');
                }, 2000);
                
            } catch (error) {
                console.error('PDF generation error:', error);
                alert('PDF generation failed. Please try again.');
            }
        }

        function printJobCard() {
            const order = orders.find(o => document.getElementById('jobCardContent').innerHTML.includes(o.id));
            if (!order) return;
            
            try {
                const doc = generateJobCardPDF(order);
                
                // Create blob and open in new window for printing
                const pdfBlob = doc.output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);
                
                const printWindow = window.open(pdfUrl, '_blank');
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                    }, 500);
                };
                
            } catch (error) {
                console.error('PDF generation error:', error);
                alert('PDF generation failed. Please try again or use your browser\'s print function.');
            }
        }

        // Dashboard filtering functions (keeping existing functionality)
        function filterDashboardOrders(status) {
            const filteredOrdersSection = document.getElementById('filteredOrdersSection');
            const filteredOrdersList = document.getElementById('filteredOrdersList');
            const filteredOrdersTitle = document.getElementById('filteredOrdersTitle');
            
            let filteredOrders = orders;
            let title = 'All Orders';
            
            if (status !== 'all') {
                filteredOrders = orders.filter(order => order.status === status);
                switch(status) {
                    case 'pending':
                        title = 'Pending Orders';
                        break;
                    case 'production':
                        title = 'Orders In Production';
                        break;
                    case 'complete':
                        title = 'Completed Orders';
                        break;
                }
            }
            
            filteredOrdersTitle.textContent = title;
            
            if (filteredOrders.length === 0) {
                filteredOrdersList.innerHTML = '<p class="text-gray-500 text-center py-8">No orders found</p>';
            } else {
                filteredOrdersList.innerHTML = filteredOrders.map(order => `
                    <div class="flex justify-between items-center p-4 border-b last:border-b-0 hover:bg-gray-50">
                        <div class="flex-1">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="font-medium text-gray-900">${order.id} - ${order.customerName}</h4>
                                    <p class="text-sm text-gray-600">${order.designNumber} ‚Ä¢ ${order.metersCount}m</p>
                                </div>
                                <span class="inline-block px-2 py-1 text-xs rounded-full ${getStatusClass(order.status)}">${getStatusText(order.status)}</span>
                            </div>
                            <div class="grid md:grid-cols-3 gap-4 text-xs text-gray-600">
                                <p>Fabric: ${order.fabricType} (${order.fabricColor})</p>
                                <p>Machine: ${order.assignedMachine}</p>
                                <p>Created: ${order.createdDate}</p>
                            </div>
                        </div>
                        <div class="ml-4 flex gap-2">
                            <button onclick="viewJobCard('${order.id}')" class="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">View</button>
                            <select onchange="updateOrderStatus('${order.id}', this.value); filterDashboardOrders('${status}')" class="px-2 py-1 border border-gray-300 rounded text-xs">
                                <option value="pending-approval" ${order.status === 'pending-approval' ? 'selected' : ''}>Pending Approval</option>
                                <option value="approved" ${order.status === 'approved' ? 'selected' : ''}>Approved</option>
                                <option value="pending" ${order
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'978b9a8bd7d34116',t:'MTc1NjgwMTM4OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
